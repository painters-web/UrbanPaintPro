<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0D9488">
    <title>UrbanPaintPro | India's #1 Painting App</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --p: #0D9488; --p-light: #14B8A6; --p-dark: #0F766E;
            --accent: #F59E0B; --bg: #F0FDFA; --text: #134E4A; 
            --white: #FFFFFF; --success: #22c55e; --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; }

        .header { 
            position: fixed; top: 0; width: 100%; height: 60px; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; z-index: 100; border-bottom: 1px solid #CCFBF1;
        }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--p); }
        .header-profile-pic { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--p-light); cursor: pointer; }

        /* Auth Modal */
        .auth-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 1000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .auth-overlay.active { display: flex; }
        .auth-modal {
            background: white; border-radius: 24px; width: 100%; max-width: 400px;
            padding: 30px; animation: popIn 0.3s;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .auth-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: var(--p); }
        .auth-subtitle { color: #64748B; margin-bottom: 25px; font-size: 0.9rem; }
        .input-group { margin-bottom: 15px; }
        .input-label { font-weight: 600; font-size: 0.85rem; color: var(--p); margin-bottom: 5px; display: block; }
        .input-field { 
            width: 100%; padding: 14px; border: 2px solid #CCFBF1; 
            border-radius: 12px; font-size: 0.95rem; outline: none;
        }
        .input-field:focus { border-color: var(--p); }
        .btn { 
            width: 100%; padding: 16px; border-radius: 12px; border: none; 
            background: var(--p); color: white; font-weight: 700; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(13,148,136,0.3);
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-accent { background: var(--accent); box-shadow: 0 4px 15px rgba(245,158,11,0.3); }
        .btn-outline { background: transparent; border: 2px solid var(--p); color: var(--p); box-shadow: none; }

        /* Hero */
        .hero { 
            margin-top: 60px; padding: 40px 20px; 
            background: linear-gradient(135deg, #0D9488 0%, #14B8A6 50%, #2DD4BF 100%);
            color: white; text-align: center; border-radius: 0 0 30px 30px;
            margin-bottom: 20px; position: relative;
        }
        .hero h1 { font-size: 1.8rem; margin-bottom: 10px; font-weight: 800; }
        .hero-stats { display: flex; justify-content: center; gap: 30px; margin-top: 20px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 1.5rem; font-weight: 800; }

        /* Calculator */
        .card { 
            background: var(--white); border-radius: 20px; padding: 20px; 
            box-shadow: 0 4px 20px rgba(13,148,136,0.08); margin: 0 20px 20px; 
            border: 1px solid #CCFBF1;
        }
        .pseudo-select { 
            width: 100%; padding: 14px; background: #F0FDFA; border: 2px solid #99F6E4; 
            border-radius: 12px; font-weight: 600; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .merged-section { 
            background: linear-gradient(135deg, #F0FDFA, #E0F2FE); 
            border-radius: 16px; padding: 15px; margin-bottom: 15px; 
            border: 2px dashed var(--p-light);
        }
        .qty-price-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 15px; background: #F0FDFA; padding: 15px; border-radius: 12px;
        }
        .qty-btn { 
            width: 36px; height: 36px; border-radius: 10px; border: none; 
            background: var(--p); color: white; cursor: pointer; font-weight: 700;
        }
        .price-amount { font-size: 1.6rem; font-weight: 800; color: var(--p); }

        /* Bottom Sheet */
        .sheet-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 1000; display: none;
        }
        .sheet-overlay.active { display: block; }
        .bottom-sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-radius: 24px 24px 0 0; transform: translateY(100%);
            transition: transform 0.3s; z-index: 1001; max-height: 70vh;
        }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { padding: 20px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; }
        .sheet-body { overflow-y: auto; padding: 10px 20px 30px; max-height: 50vh; }
        .option-item { 
            padding: 16px; border-bottom: 1px solid #F0FDFA; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .option-item.selected { background: #CCFBF1; border-radius: 8px; }
        .option-check { color: var(--p); opacity: 0; }
        .option-item.selected .option-check { opacity: 1; }

        /* Toast */
        .toast-container { 
            position: fixed; top: 70px; right: 20px; z-index: 10000; 
            display: flex; flex-direction: column; gap: 10px; 
        }
        .toast { 
            background: white; padding: 14px 20px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; 
            align-items: center; gap: 12px; animation: slideIn 0.3s;
            border-left: 4px solid var(--p); min-width: 280px;
        }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Nav */
        .nav { 
            position: fixed; bottom: 0; width: 100%; height: 75px; 
            background: var(--white); border-top: 1px solid #CCFBF1; 
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { text-align: center; color: #94A3B8; font-size: 0.75rem; font-weight: 700; width: 60px; cursor: pointer; padding: 8px; border-radius: 12px; }
        .nav-item.active { color: var(--p); background: #F0FDFA; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }

        /* Loading */
        .loading-spinner {
            width: 20px; height: 20px; border: 2px solid white;
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (min-width: 768px) {
            body { max-width: 480px; margin: 0 auto; }
            .nav, .header { max-width: 480px; left: 50%; transform: translateX(-50%); }
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Modal -->
    <div class="auth-overlay" id="authModal">
        <div class="auth-modal">
            <div class="auth-title">Welcome Back! ðŸ‘‹</div>
            <div class="auth-subtitle">Login to book services & track orders</div>
            
            <div class="input-group">
                <label class="input-label">Phone Number</label>
                <input type="tel" class="input-field" id="phoneInput" placeholder="+91 98765 43210" maxlength="10">
            </div>
            
            <div class="input-group" id="otpGroup" style="display: none;">
                <label class="input-label">Enter OTP</label>
                <input type="number" class="input-field" id="otpInput" placeholder="123456" maxlength="6">
            </div>
            
            <button class="btn" id="authBtn" onclick="sendOTP()">
                <span>Send OTP</span>
            </button>
            
            <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #64748B;">
                New user? <a href="#" style="color: var(--p); font-weight: 600;">Create account</a>
            </p>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="logo">Urban<span style="color:#64748B;">PaintPro</span></div>
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="header-profile-pic" id="headerProfile" onclick="checkAuth()" alt="Profile">
    </div>

    <!-- Hero -->
    <div class="hero">
        <h1 id="greeting">Paint Your Dreams! ðŸŽ¨</h1>
        <p>Professional painters at your doorstep</p>
        <div class="hero-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalUsers">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Happy Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">4.9â˜…</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Rating</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalOrders">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Orders</div>
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="card">
        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--p-dark);">
            <i class="fa-solid fa-calculator" style="margin-right: 8px;"></i>Smart Calculator
        </div>
        
        <div class="input-group">
            <label style="font-weight: 700; font-size: 0.85rem; color: var(--p); margin-bottom: 5px; display: block;">City</label>
            <div class="pseudo-select" onclick="openSelector('city')">
                <span id="cityText">Delhi</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
        </div>

        <div class="input-group">
            <label style="font-weight: 700; font-size: 0.85rem; color: var(--p); margin-bottom: 5px; display: block;">Room Size</label>
            <div class="pseudo-select" onclick="openSelector('room')">
                <span id="roomText">1 BHK Flat (1500 sqft)</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
        </div>

        <div class="merged-section">
            <div class="input-group">
                <label style="font-weight: 700; font-size: 0.85rem; color: var(--p); margin-bottom: 5px; display: block;">Brand</label>
                <div class="pseudo-select" onclick="openSelector('brand')">
                    <span id="brandText">Asian Paints</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
            </div>
            <div class="input-group">
                <label style="font-weight: 700; font-size: 0.85rem; color: var(--p); margin-bottom: 5px; display: block;">Product</label>
                <div class="pseudo-select" onclick="openSelector('product')">
                    <span id="productText">Royale Luxury - â‚¹26/sqft</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
            </div>
        </div>

        <div class="qty-price-row">
            <div>
                <span style="color: #64748B; font-size: 0.85rem;">Quantity</span>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <button class="qty-btn" onclick="updateQty(-1)">âˆ’</button>
                    <strong id="qtyValue" style="font-size: 1.2rem; min-width: 30px; text-align: center;">1</strong>
                    <button class="qty-btn" onclick="updateQty(1)">+</button>
                </div>
            </div>
            <div style="text-align: right;">
                <span style="color: #64748B; font-size: 0.85rem;">Estimated</span>
                <div class="price-amount" id="totalPrice">â‚¹39,000</div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-outline" onclick="saveEstimate()">
                <i class="fa-solid fa-save"></i> Save
            </button>
            <button class="btn btn-accent" onclick="bookNow()">
                Book Now <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-header">
            <span style="font-weight: 700; font-size: 1.1rem;" id="sheetTitle">Select</span>
            <div style="width: 32px; height: 32px; background: #F0FDFA; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="closeSheet()">
                <i class="fa-solid fa-xmark" style="color: var(--p);"></i>
            </div>
        </div>
        <div class="sheet-body" id="sheetBody"></div>
    </div>

    <!-- Nav -->
    <div class="nav">
        <div class="nav-item active" onclick="navigate('index.html')">
            <i class="fa-solid fa-house"></i><span>Home</span>
        </div>
        <div class="nav-item" onclick="navigate('services.html')">
            <i class="fa-solid fa-paint-roller"></i><span>Services</span>
        </div>
        <div class="nav-item" onclick="navigate('bookings.html')">
            <i class="fa-solid fa-box-open"></i><span>Orders</span>
        </div>
        <div class="nav-item" onclick="navigate('about.html')">
            <i class="fa-solid fa-user"></i><span>Profile</span>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        // YEH AAPKE FIREBASE CONSOLE SE COPY KAREIN
        const firebaseConfig = {
        apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
        authDomain: "urban-paint-pro.firebaseapp.com",
        databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "urban-paint-pro",
        storageBucket: "urban-paint-pro.firebasestorage.app",
        messagingSenderId: "929763117480",
        appId: "1:929763117480:web:560057baeb12672078b59d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
       l
        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let userData = null;
        
        const calculatorState = {
            city: { value: 'delhi', label: 'Delhi', multiplier: 1.2 },
            room: { value: 1500, label: '1 BHK Flat (1500 sqft)' },
            brand: 'Asian Paints',
            product: { name: 'Royale Luxury', price: 26 },
            qty: 1
        };

        // ==================== AUTH FUNCTIONS ====================
        
        // Check if user is logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authModal').classList.remove('active');
                loadUserData(user.uid);
                updateHeader(user);
            } else {
                // Show auth modal after delay
                setTimeout(() => {
                    document.getElementById('authModal').classList.add('active');
                }, 1000);
            }
        });

        function checkAuth() {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('active');
            } else {
                navigate('about.html');
            }
        }

        // Phone Auth (Firebase)
        let confirmationResult = null;
        
        async function sendOTP() {
            const btn = document.getElementById('authBtn');
            const phone = document.getElementById('phoneInput').value;
            
            if (phone.length !== 10) {
                showToast('Enter valid 10-digit number', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // For demo: Direct login without OTP (development mode)
                // Production mein: firebase.auth().signInWithPhoneNumber()
                
                const email = `+91${phone}@urbanpaintpro.com`;
                const password = phone; // In production, use proper auth
                
                // Create or login user
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                } catch (e) {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                
                showToast('Login successful!', 'success');
                
            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<span>Send OTP</span>';
            }
        }

        // ==================== FIREBASE DATABASE OPERATIONS ====================

        // 1. READ: Load user data from Firebase
        async function loadUserData(uid) {
            try {
                const snapshot = await db.ref(`users/${uid}`).once('value');
                userData = snapshot.val() || {};
                
                // Set greeting
                const name = userData.profile?.name || 'User';
                document.getElementById('greeting').textContent = `Hello, ${name}! ðŸŽ¨`;
                
                // Load saved calculator state if exists
                if (userData.lastEstimate) {
                    calculatorState.qty = userData.lastEstimate.qty || 1;
                    document.getElementById('qtyValue').textContent = calculatorState.qty;
                }
                
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        // 2. READ: Load site statistics
        async function loadStats() {
            try {
                // Total users
                const usersSnap = await db.ref('users').once('value');
                const totalUsers = usersSnap.numChildren();
                document.getElementById('totalUsers').textContent = totalUsers + 'k+';
                
                // Total orders
                const ordersSnap = await db.ref('orders').once('value');
                const totalOrders = ordersSnap.numChildren();
                document.getElementById('totalOrders').textContent = totalOrders + 'k';
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // 3. WRITE: Save estimate to Firebase
        async function saveEstimate() {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('active');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div> Saving...';

            try {
                const estimateData = {
                    city: calculatorState.city,
                    room: calculatorState.room,
                    brand: calculatorState.brand,
                    product: calculatorState.product,
                    qty: calculatorState.qty,
                    total: calculateTotal(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                // Save to user's estimates
                await db.ref(`users/${currentUser.uid}/estimates`).push(estimateData);
                
                // Save as last estimate
                await db.ref(`users/${currentUser.uid}/lastEstimate`).set(estimateData);
                
                showToast('Estimate saved to cloud!', 'success');
                
            } catch (error) {
                showToast('Error saving: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save"></i> Save';
            }
        }

        // 4. WRITE: Create new booking
        async function bookNow() {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('active');
                return;
            }

            const total = calculateTotal();
            const confirmBooking = confirm(`Confirm booking?\nTotal: â‚¹${total.toLocaleString()}`);
            
            if (!confirmBooking) return;

            try {
                const orderData = {
                    userId: currentUser.uid,
                    userPhone: currentUser.email?.replace('@urbanpaintpro.com', '') || '',
                    service: `${calculatorState.room.label} - ${calculatorState.brand}`,
                    details: {
                        city: calculatorState.city.label,
                        room: calculatorState.room.label,
                        brand: calculatorState.brand,
                        product: calculatorState.product.name,
                        qty: calculatorState.qty
                    },
                    amount: total,
                    status: 'pending',
                    paymentStatus: 'pending',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };

                // Create order
                const newOrderRef = db.ref('orders').push();
                await newOrderRef.set(orderData);
                
                // Add to user's orders
                await db.ref(`users/${currentUser.uid}/orders/${newOrderRef.key}`).set({
                    ...orderData,
                    orderId: newOrderRef.key
                });
                
                // Create notification
                await db.ref(`users/${currentUser.uid}/notifications`).push({
                    title: 'Booking Confirmed!',
                    message: `Your order #${newOrderRef.key.slice(-6).toUpperCase()} is received.`,
                    type: 'order',
                    read: false,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                showToast('Booking confirmed! Redirecting...', 'success');
                
                setTimeout(() => {
                    navigate('bookings.html');
                }, 1500);
                
            } catch (error) {
                showToast('Booking failed: ' + error.message, 'error');
            }
        }

        // ==================== CALCULATOR FUNCTIONS ====================
        
        const data = {
            cities: [
                { value: 'delhi', label: 'Delhi', multiplier: 1.2 },
                { value: 'noida', label: 'Noida', multiplier: 1.15 },
                { value: 'gurgaon', label: 'Gurgaon', multiplier: 1.3 },
                { value: 'faridabad', label: 'Faridabad', multiplier: 1.1 }
            ],
            rooms: [
                { value: 120, label: '1 Wall Small (120 sqft)' },
                { value: 200, label: '1 Wall Large (200 sqft)' },
                { value: 380, label: 'Standard Bedroom (380 sqft)' },
                { value: 600, label: 'Living Room (600 sqft)' },
                { value: 1500, label: '1 BHK Flat (1500 sqft)' },
                { value: 2500, label: '2 BHK Flat (2500 sqft)' },
                { value: 3500, label: '3 BHK Flat (3500 sqft)' }
            ],
            brands: {
                'Asian Paints': [
                    { name: 'Tractor Emulsion', price: 12 },
                    { name: 'Apcolite Premium', price: 20 },
                    { name: 'Royale Luxury', price: 26 },
                    { name: 'Royale Aspira', price: 35 }
                ],
                'Berger Paints': [
                    { name: 'Bison Emulsion', price: 13 },
                    { name: 'Silk Glamor', price: 28 },
                    { name: 'WeatherCoat', price: 22 }
                ],
                'Nerolac': [
                    { name: 'Beauty Smooth', price: 14 },
                    { name: 'Excel Total', price: 18 },
                    { name: 'Impressions', price: 24 }
                ],
                'Dulux': [
                    { name: 'SuperCover', price: 16 },
                    { name: 'Weathershield', price: 28 },
                    { name: 'Velvet Touch', price: 32 }
                ]
            }
        };

        function calculateTotal() {
            const laborCost = 8;
            const costPerSqft = calculatorState.product.price + laborCost;
            const total = Math.round(costPerSqft * calculatorState.room.value * calculatorState.qty * calculatorState.city.multiplier);
            document.getElementById('totalPrice').textContent = 'â‚¹' + total.toLocaleString('en-IN');
            return total;
        }

        function updateQty(change) {
            const newQty = calculatorState.qty + change;
            if (newQty < 1) return;
            calculatorState.qty = newQty;
            document.getElementById('qtyValue').textContent = newQty;
            calculateTotal();
        }

        // ==================== UI FUNCTIONS ====================
        
        let currentSelector = null;

        function openSelector(type) {
            currentSelector = type;
            const sheet = document.getElementById('bottomSheet');
            const overlay = document.getElementById('sheetOverlay');
            const title = document.getElementById('sheetTitle');
            const body = document.getElementById('sheetBody');
            
            let options = [];
            let currentValue = null;
            
            switch(type) {
                case 'city':
                    title.textContent = 'Select City';
                    options = data.cities.map(c => ({ value: c.value, label: c.label, data: c }));
                    currentValue = calculatorState.city.value;
                    break;
                case 'room':
                    title.textContent = 'Select Room Size';
                    options = data.rooms.map(r => ({ value: r.value, label: r.label, data: r }));
                    currentValue = calculatorState.room.value;
                    break;
                case 'brand':
                    title.textContent = 'Select Brand';
                    options = Object.keys(data.brands).map(b => ({ value: b, label: b }));
                    currentValue = calculatorState.brand;
                    break;
                case 'product':
                    title.textContent = 'Select Product';
                    options = data.brands[calculatorState.brand].map(p => ({
                        value: p.name,
                        label: `${p.name} - â‚¹${p.price}/sqft`,
                        data: p
                    }));
                    currentValue = calculatorState.product.name;
                    break;
            }
            
            body.innerHTML = options.map(opt => `
                <div class="option-item ${opt.value === currentValue ? 'selected' : ''}" 
                     onclick="selectOption('${type}', '${opt.value}', ${JSON.stringify(opt.data || opt.label).replace(/"/g, '&quot;')})">
                    <span>${opt.label}</span>
                    <i class="fa-solid fa-check option-check"></i>
                </div>
            `).join('');
            
            overlay.classList.add('active');
            sheet.classList.add('active');
        }

        function selectOption(type, value, data) {
            switch(type) {
                case 'city':
                    calculatorState.city = data;
                    document.getElementById('cityText').textContent = data.label;
                    break;
                case 'room':
                    calculatorState.room = data;
                    document.getElementById('roomText').textContent = data.label;
                    break;
                case 'brand':
                    calculatorState.brand = value;
                    calculatorState.product = data.brands[value][0];
                    document.getElementById('brandText').textContent = value;
                    document.getElementById('productText').textContent = 
                        `${calculatorState.product.name} - â‚¹${calculatorState.product.price}/sqft`;
                    break;
                case 'product':
                    calculatorState.product = data;
                    document.getElementById('productText').textContent = 
                        `${data.name} - â‚¹${data.price}/sqft`;
                    break;
            }
            calculateTotal();
            closeSheet();
        }

        function closeSheet() {
            document.getElementById('sheetOverlay').classList.remove('active');
            document.getElementById('bottomSheet').classList.remove('active');
        }

        function updateHeader(user) {
            // Update profile pic if available
            const profilePic = user.photoURL || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            document.getElementById('headerProfile').src = profilePic;
        }

        function navigate(url) {
            window.location.href = url;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'xmark-circle' : 'info-circle';
            const color = type === 'success' ? 'var(--success)' : 
                         type === 'error' ? 'var(--error)' : 'var(--p)';
            
            toast.innerHTML = `
                <i class="fa-solid fa-${icon}" style="color: ${color}; font-size: 1.2rem;"></i>
                <span style="font-weight: 600; color: #334155;">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            calculateTotal();
            loadStats();
            
            // Real-time stats listener
            db.ref('orders').on('value', (snapshot) => {
                const count = snapshot.numChildren();
                document.getElementById('totalOrders').textContent = count + 'k';
            });
        });
    </script>
</body>
</html>