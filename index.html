<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Book professional home painters, waterproofing, and wall texture designs online. India's #1 Painting App.">
    <meta name="keywords" content="painters near me, home painting services, house painters, wall texture design, waterproofing contractors, urban paint pro">
    <meta name="author" content="Urban Paint Pro">
    <meta name="robots" content="index, follow">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVXJiYW5QYWludFBybyIsInNob3J0X25hbWUiOiJQYWludFBybyIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjNEY0NkU1IiwiaWNvbnMiOlt7InNyYyI6ImFzc2V0cy9sb2dvLnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="UrbanPaintPro">
    <link rel="apple-touch-icon" href="assets/logo.png">
    
    <!-- CSP for Security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src https://*.firebaseio.com https://*.googleapis.com;">
    
    <title>UrbanPaintPro | India's #1 Painting App</title>
    
    <link rel="icon" type="image/png" href="assets/logo.png">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Urban Paint Pro - Professional Painting Services">
    <meta property="og:description" content="Book expert painters for your home. Quality work, best prices.">
    <meta property="og:image" content="https://urbanpaintpro.in/assets/logo.png">
    <meta property="og:url" content="https://urbanpaintpro.in">
    <meta property="og:type" content="website">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --p: #4F46E5; 
            --bg: #F8FAFC; 
            --text: #0F172A; 
            --white: #FFFFFF; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Splash */
        #splash { position: fixed; inset: 0; background: var(--white); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .logo-load { font-size: 2rem; font-weight: 800; color: var(--p); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } }

        /* Header */
        .header { position: absolute; top: 0; width: 100%; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; border-bottom: 1px solid #F1F5F9; }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--p); }
        .user-icon { width: 32px; height: 32px; border-radius: 50%; background: #EEF2FF; display: flex; align-items: center; justify-content: center; color: var(--p); cursor: pointer; border: 1px solid #E2E8F0; }
        .notification-badge { position: absolute; top: -2px; right: -2px; background: var(--error); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; display: none; }
        
        /* Install Prompt */
        .install-prompt { position: fixed; bottom: 80px; left: 20px; right: 20px; background: var(--p); color: white; padding: 15px; border-radius: 12px; display: none; align-items: center; justify-content: space-between; z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Loading States */
        .btn-loading { position: relative; pointer-events: none; opacity: 0.7; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; border: 2px solid transparent; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Pages */
        .page { height: 100%; padding: 80px 20px 100px; overflow-y: auto; display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Inputs */
        .card { background: var(--white); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .inp { width: 100%; padding: 14px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; font-weight: 600; font-size: 0.9rem; outline: none; margin-bottom: 10px; transition: 0.3s; }
        .inp:focus { background: var(--white); border-color: var(--p); }
        .inp:invalid { border-color: var(--error); }
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; background: var(--p); color: white; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79,70,229,0.3); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.outline { background: transparent; border: 2px solid #E2E8F0; color: var(--text); }
        .btn.outline:hover { border-color: var(--p); color: var(--p); }
        .btn.success { background: var(--success); }
        .btn.error { background: var(--error); }
        .btn.whatsapp { background: #25D366; }
        .btn.whatsapp:hover { background: #128C7E; }

        /* Error Messages */
        .error-msg { color: var(--error); font-size: 0.8rem; margin-top: -5px; margin-bottom: 10px; display: none; }
        .error-msg.show { display: block; }
        .input-group { margin-bottom: 10px; }

        /* Merged Scope Section */
        .merged-section { background: #EEF2FF; border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px dashed var(--p); }
        .merged-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .merged-label { font-weight: 700; font-size: 0.85rem; color: var(--p); }

        /* Full Screen Sheets - Enhanced */
        .full-sheet { position: fixed; inset: 0; background: var(--bg); z-index: 5000; transform: translateX(100%); transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .full-sheet.active { transform: translateX(0); }
        .fs-header { padding: 15px 20px; background: var(--white); border-bottom: 1px solid #F1F5F9; display: flex; align-items: center; gap: 15px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .fs-header i { cursor: pointer; padding: 8px; margin: -8px; border-radius: 50%; transition: 0.2s; }
        .fs-header i:hover { background: #F1F5F9; }
        .fs-body { flex: 1; overflow-y: auto; padding: 20px; }

        /* Overlay - for closing */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; backdrop-filter: blur(3px); }
        .overlay.active { display: block; }

        /* Menu Items */
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 18px; border-bottom: 1px solid #F8FAFC; cursor: pointer; transition: 0.2s; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: #F8FAFC; }
        .menu-item:active { background: #F1F5F9; }
        .menu-item i { width: 25px; font-size: 1.2rem; }
        .menu-item span { flex: 1; font-weight: 600; font-size: 0.95rem; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 45px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--p); }
        input:checked + .slider:before { transform: translateX(21px); }

        /* Tracking Timeline */
        .uber-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.12); margin-bottom: 25px; position: relative; border: 1px solid rgba(0,0,0,0.05); font-family: 'Plus Jakarta Sans', sans-serif; }
        .map-zone { height: 260px; width: 100%; background-image: url('https://i.imgur.com/8J5b8wN.png'); background-size: cover; background-position: center; position: relative; overflow: hidden; }
        .radar-scan { position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; background: rgba(79, 70, 229, 0.1); border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid rgba(79, 70, 229, 0.3); animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .radar-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: #4F46E5; background: white; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2); z-index: 2; }
        .live-marker { position: absolute; top: 50%; left: 50%; width: 55px; height: 55px; border: 3px solid white; border-radius: 50%; box-shadow: 0 10px 25px rgba(0,0,0,0.3); transform: translate(-50%, -50%); z-index: 10; animation: bounce 2s infinite; background: white; }
        .live-marker img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .partner-float { position: absolute; bottom: 20px; left: 15px; right: 15px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); padding: 15px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6); transform: translateY(100px); opacity: 0; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .partner-float.visible { transform: translateY(0); opacity: 1; }
        .p-details { display: flex; align-items: center; gap: 12px; }
        .p-name { font-weight: 700; color: #1F2937; font-size: 15px; margin-bottom: 2px; }
        .p-otp { font-size: 11px; color: #6B7280; background: #F3F4F6; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .call-btn { width: 45px; height: 45px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); font-size: 18px; text-decoration: none; }
        .status-sheet { padding: 25px 20px; background: white; position: relative; z-index: 5; border-radius: 24px 24px 0 0; margin-top: -20px; }
        .drag-bar { width: 40px; height: 4px; background: #E5E7EB; border-radius: 10px; margin: 0 auto 20px; }
        .u-step { display: flex; gap: 15px; margin-bottom: 25px; position: relative; opacity: 0.5; transition: 0.3s; }
        .u-step.active { opacity: 1; }
        .u-step.done { opacity: 1; }
        .u-line { position: absolute; left: 15px; top: 35px; bottom: -25px; width: 2px; background: #E5E7EB; }
        .u-step:last-child .u-line { display: none; }
        .u-icon { width: 32px; height: 32px; background: #F3F4F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; z-index: 2; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; }
        .u-step.active .u-icon { background: #4F46E5; color: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15); transform: scale(1.1); }
        .u-step.done .u-icon { background: #10B981; color: white; }
        @keyframes ping { 75%, 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translate(-50%, -50%) translateY(0); } 50% { transform: translate(-50%, -50%) translateY(-10px); } }
        
        /* Chatbot UI */
        .chat-container { display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .chat-msg { padding: 12px 16px; border-radius: 12px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
        .chat-ai { background: #EEF2FF; color: #1E293B; border-bottom-left-radius: 2px; align-self: flex-start; }
        .chat-user { background: var(--p); color: white; border-bottom-right-radius: 2px; align-self: flex-end; }
        .chat-input { display: flex; gap: 10px; padding: 15px; border-top: 1px solid #F1F5F9; background: white; }

        /* UPI Payment UI */
        .qr-frame { width: 220px; height: 220px; margin: 0 auto 20px; border: 2px solid #e0e0e0; padding: 10px; border-radius: 12px; background: white; }
        .qr-frame img { width: 100%; height: 100%; object-fit: contain; }
        .upi-copy-box { background: #eef2ff; padding: 12px; border-radius: 8px; border: 1px dashed var(--p); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        /* Nav */
        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--white); border-top: 1px solid #F1F5F9; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: 10px; }
        .nav-item { text-align: center; color: #94A3B8; font-size: 0.75rem; font-weight: 700; width: 60px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--p); transform: translateY(-2px); }
        .nav-item:hover { color: var(--p); }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }

        /* Status Animations */
        .status-screen { position: fixed; inset: 0; background: white; z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .status-screen.active { display: flex; }
        .icon-circle { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 20px; animation: scaleIn 0.5s; }
        .success-icon { background: #dcfce7; color: var(--success); }
        .error-icon { background: #fee2e2; color: var(--error); }
        @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 70px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideInRight 0.3s; border-left: 4px solid var(--p); min-width: 250px; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--error); }
        .toast.warning { border-left-color: var(--warning); }
        @keyframes slideInRight { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Offline Indicator */
        .offline-bar { position: fixed; top: 0; left: 0; right: 0; background: var(--error); color: white; text-align: center; padding: 8px; z-index: 10001; display: none; font-size: 0.9rem; }
        .offline-bar.show { display: block; }
        
        /* Image Upload */
        .upload-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { border-color: var(--p); background: #F8FAFC; }
        .upload-preview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .upload-preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        
        /* Rating Stars */
        .rating { display: flex; gap: 5px; font-size: 1.5rem; color: #ccc; }
        .rating .star.active { color: #fbbf24; }
        
        /* Help Center Styles */
        .help-card { background: var(--white); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .help-item { display: flex; align-items: center; gap: 15px; padding: 16px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; text-decoration: none; color: inherit; }
        .help-item:hover { background: #F8FAFC; transform: translateX(5px); }
        .help-item.ai { background: linear-gradient(135deg, #EEF2FF, #FFFFFF); border: 1px solid #C7D2FE; }
        .help-item.ai:hover { background: linear-gradient(135deg, #DDD6FE, #EEF2FF); }
        .help-item.whatsapp { background: linear-gradient(135deg, #DCFCE7, #FFFFFF); border: 1px solid #86EFAC; }
        .help-item.whatsapp:hover { background: linear-gradient(135deg, #BBF7D0, #DCFCE7); }
        .help-item.email { background: linear-gradient(135deg, #FEE2E2, #FFFFFF); border: 1px solid #FECACA; }
        .help-item.email:hover { background: linear-gradient(135deg, #FECACA, #FEE2E2); }
        .help-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .help-icon.ai { background: var(--p); color: white; }
        .help-icon.whatsapp { background: #25D366; color: white; }
        .help-icon.email { background: #EA4335; color: white; }
        .help-info { flex: 1; }
        .help-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
        .help-subtitle { font-size: 0.85rem; color: #64748B; }
        
        /* Full Sheet Form Styles */
        .form-section { background: var(--white); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #374151; margin-bottom: 8px; display: block; }
        .form-hint { font-size: 0.8rem; color: #6B7280; margin-top: 4px; }
        
        /* Responsive */
        @media (min-width: 768px) {
            body { max-width: 480px; margin: 0 auto; border-left: 1px solid #eee; border-right: 1px solid #eee; }
            .nav, .header { max-width: 480px; left: 50%; transform: translateX(-50%); }
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offline-bar" class="offline-bar">
        <i class="fas fa-wifi-slash"></i> You are offline. Some features may not work.
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Install Prompt -->
    <div id="install-prompt" class="install-prompt">
        <div>
            <strong>Install UrbanPaintPro</strong>
            <div style="font-size: 0.8rem; opacity: 0.9;">Add to home screen for better experience</div>
        </div>
        <button onclick="installApp()" style="background: white; color: var(--p); border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer;">Install</button>
    </div>

    <div id="splash"><div class="logo-load">UrbanPaintPro</div></div>

    <div class="header">
        <div class="logo">Urban<span>PaintPro</span></div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="user-icon" onclick="nav('notifications')" style="position: relative;">
                <i class="fa-regular fa-bell"></i>
                <span id="notif-badge" class="notification-badge">0</span>
            </div>
            <div class="user-icon" onclick="nav('account')">
                <i class="fa-regular fa-user"></i>
            </div>
        </div>
    </div>

    <!-- Overlay for closing sheets -->
    <div class="overlay" id="overlay" onclick="closeAllSheets()"></div>

    <!-- ==================== FULL SHEET MODALS ==================== -->

    <!-- BOOKING FULL SHEET -->
    <div class="full-sheet" id="fs-book">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-book')"></i>
            <span>Confirm Booking</span>
        </div>
        <div class="fs-body">
            <div class="form-section">
                <label class="form-label">Service Type</label>
                <select id="serviceType" class="inp">
                    <option value="painting">Painting</option>
                    <option value="waterproofing">Waterproofing</option>
                    <option value="texture">Texture</option>
                </select>
            </div>
            
            <div class="form-section">
                <label class="form-label">Select Date</label>
                <input type="date" id="slotDate" class="inp" min="">
                <div class="error-msg" id="date-error">Please select a future date</div>
                
                <label class="form-label" style="margin-top: 15px;">Select Time</label>
                <select id="slotTime" class="inp">
                    <option value="09:00">9:00 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="12:00">12:00 PM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="16:00">4:00 PM</option>
                    <option value="17:00">5:00 PM</option>
                    <option value="18:00">6:00 PM</option>
                    <option value="19:00">7:00 PM</option>
                    <option value="20:00">8:00 PM</option>
                </select>
            </div>
            
            <div class="form-section" style="background: #F0FDF4; border: 1px solid #86EFAC;">
                <div style="display: flex; align-items: center; gap: 8px; color: #166534;">
                    <i class="fa-solid fa-tag"></i>
                    <span style="font-weight: 600;" id="visit-charge-display">Visiting Charge: ‚Çπ49</span>
                </div>
            </div>
            
            <div class="form-section">
                <button class="btn outline" style="margin-bottom:15px; border-color:var(--p); color:var(--p);" onclick="autoLoc()">
                    <i class="fa-solid fa-location-dot"></i> Auto Detect Location
                </button>
                
                <label class="form-label">Full Address</label>
                <input type="text" id="b-addr" class="inp" placeholder="House No, Street, Area, Landmark">
                <div class="error-msg" id="addr-error">Address is required</div>
                
                <label class="form-label" style="margin-top: 15px;">Pincode</label>
                <input type="text" id="b-pin" class="inp" placeholder="6-digit pincode" maxlength="6" oninput="validatePincode(this)">
                <div class="error-msg" id="pin-error">Valid 6-digit pincode required</div>
                
                <label class="form-label" style="margin-top: 15px;">Additional Notes (Optional)</label>
                <textarea id="b-notes" class="inp" placeholder="Any specific requirements..." rows="3" style="resize: none;"></textarea>
            </div>
            
            <button class="btn" onclick="placeOrder()" id="place-order-btn">
                <span>Pay & Confirm</span>
            </button>
        </div>
    </div>

    <!-- TERMS FULL SHEET -->
    <div class="full-sheet" id="fs-tnc">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-tnc')"></i>
            <span>Terms & Conditions</span>
        </div>
        <div class="fs-body">
            <div class="form-section">
                <div style="padding: 20px; background: #F8FAFC; border-radius: 12px; line-height: 1.8;">
                    <h4 style="margin-bottom: 15px; color: var(--p);">1. Visit Charges</h4>
                    <p style="margin-bottom: 20px; color: #444; font-size: 0.95rem;">Visit charges of ‚Çπ49 are non-refundable but adjustable in final bill.</p>
                    
                    <h4 style="margin-bottom: 15px; color: var(--p);">2. Final Quote</h4>
                    <p style="margin-bottom: 20px; color: #444; font-size: 0.95rem;">Final quote provided after physical inspection only.</p>
                    
                    <h4 style="margin-bottom: 15px; color: var(--p);">3. Service Area</h4>
                    <p style="margin-bottom: 20px; color: #444; font-size: 0.95rem;">We currently serve Delhi NCR region only.</p>
                    
                    <h4 style="margin-bottom: 15px; color: var(--p);">4. Cancellation Policy</h4>
                    <p style="margin-bottom: 20px; color: #444; font-size: 0.95rem;">Cancellation must be done 2 hours before scheduled time.</p>
                    
                    <h4 style="margin-bottom: 15px; color: var(--p);">5. Warranty</h4>
                    <p style="color: #444; font-size: 0.95rem;">Warranty valid only on completion of full payment.</p>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn outline" onclick="closeFS('fs-tnc')">Decline</button>
                <button class="btn" onclick="acceptTNC()">Accept & Continue</button>
            </div>
        </div>
    </div>

    <!-- LOGIN FULL SHEET -->
    <div class="full-sheet" id="fs-login">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-login')"></i>
            <span>Login</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--p), #7C3AED); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <i class="fa-solid fa-user" style="font-size: 2rem; color: white;"></i>
                </div>
                <h2>Welcome Back!</h2>
                <p style="color: #64748B; font-size: 0.9rem;">Login to manage your bookings</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">Email Address</label>
                <input type="email" id="fs-l-email" class="inp" placeholder="your@email.com">
                <div class="error-msg" id="fs-l-email-error">Please enter a valid email</div>
                
                <label class="form-label" style="margin-top: 15px;">Password</label>
                <input type="password" id="fs-l-pass" class="inp" placeholder="Enter your password">
                <div class="error-msg" id="fs-l-pass-error">Password must be at least 6 characters</div>
                
                <p style="text-align: right; margin-top: 10px;">
                    <a href="#" onclick="resetPass()" style="color: var(--p); font-size: 0.85rem; text-decoration: none;">Forgot Password?</a>
                </p>
            </div>
            
            <button class="btn" onclick="loginFromSheet()" id="fs-login-btn">Login</button>
            
            <div style="text-align: center; margin: 20px 0;">
                <span style="color: #94A3B8; font-size: 0.9rem;">OR</span>
            </div>
            
            <button class="btn outline" onclick="googleLogin()" style="border-color: #EA4335; color: #EA4335;">
                <i class="fa-brands fa-google"></i> Continue with Google
            </button>
            
            <p style="text-align: center; margin-top: 20px; color: #64748B; font-size: 0.9rem;">
                Don't have an account? <a href="#" onclick="switchAuth('signup')" style="color: var(--p); font-weight: 600; text-decoration: none;">Sign Up</a>
            </p>
        </div>
    </div>

    <!-- SIGNUP FULL SHEET -->
    <div class="full-sheet" id="fs-signup">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-signup')"></i>
            <span>Create Account</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--success), #10B981); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <i class="fa-solid fa-user-plus" style="font-size: 2rem; color: white;"></i>
                </div>
                <h2>Join UrbanPaintPro</h2>
                <p style="color: #64748B; font-size: 0.9rem;">Create an account to get started</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">Full Name</label>
                <input type="text" id="s-name" class="inp" placeholder="Your full name">
                <div class="error-msg" id="s-name-error">Name must be at least 2 characters</div>
                
                <label class="form-label" style="margin-top: 15px;">Email Address</label>
                <input type="email" id="s-email" class="inp" placeholder="your@email.com">
                <div class="error-msg" id="s-email-error">Please enter a valid email</div>
                
                <label class="form-label" style="margin-top: 15px;">Phone Number</label>
                <input type="tel" id="s-phone" class="inp" placeholder="10-digit mobile number" maxlength="10">
                <div class="error-msg" id="s-phone-error">Please enter a valid 10-digit number</div>
                
                <label class="form-label" style="margin-top: 15px;">Password</label>
                <input type="password" id="s-pass" class="inp" placeholder="Create a password (min 6 chars)">
                <div class="error-msg" id="s-pass-error">Password must be at least 6 characters</div>
            </div>
            
            <button class="btn" onclick="signup()" id="signup-btn">Create Account</button>
            
            <div style="text-align: center; margin: 20px 0;">
                <span style="color: #94A3B8; font-size: 0.9rem;">OR</span>
            </div>
            
            <button class="btn outline" onclick="googleLogin()" style="border-color: #EA4335; color: #EA4335;">
                <i class="fa-brands fa-google"></i> Continue with Google
            </button>
            
            <p style="text-align: center; margin-top: 20px; color: #64748B; font-size: 0.9rem;">
                Already have an account? <a href="#" onclick="switchAuth('login')" style="color: var(--p); font-weight: 600; text-decoration: none;">Login</a>
            </p>
        </div>
    </div>

    <!-- PAYMENT FULL SHEET -->
    <div class="full-sheet" id="fs-payment">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-payment')"></i>
            <span>Complete Payment</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <i class="fa-solid fa-indian-rupee-sign" style="font-size: 2.5rem; color: #92400E;"></i>
                </div>
                <h2 id="pay-amt-display" style="font-size: 2.5rem; color: var(--p);">‚Çπ49</h2>
                <p style="color: #64748B; font-size: 0.9rem;">Visiting Charge</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">Pay via UPI</label>
                <div class="upi-copy-box">
                    <span style="font-weight: 700; color: var(--p);">kingkhan33648@okicici</span>
                    <button onclick="copyUPI()" style="background: var(--p); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                        <i class="fa-regular fa-copy"></i> Copy
                    </button>
                </div>
                
                <div class="qr-frame">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=kingkhan33648@okicici&pn=UrbanPaintPro" alt="UPI QR Code">
                </div>
                <p class="form-hint" style="text-align: center;">Scan with any UPI app (PhonePe, GPay, Paytm)</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">Enter UTR Number (12 digits)</label>
                <input type="text" id="utr-input" class="inp" placeholder="Enter UTR/Transaction ID" maxlength="12">
                <div class="error-msg" id="utr-error">Please enter valid 12-digit UTR number</div>
                <p class="form-hint">You can find UTR in your UPI app transaction history</p>
            </div>
            
            <button class="btn" onclick="verifyPayment()" id="verify-payment-btn">
                <i class="fa-solid fa-check-circle"></i> I've Paid - Verify
            </button>
        </div>
    </div>

    <!-- RATING FULL SHEET -->
    <div class="full-sheet" id="fs-rating">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-rating')"></i>
            <span>Rate Your Experience</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #FEF3C7, #FBBF24); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <i class="fa-solid fa-star" style="font-size: 2rem; color: white;"></i>
                </div>
                <h2>How was your service?</h2>
                <p style="color: #64748B; font-size: 0.9rem;">Your feedback helps us improve</p>
            </div>
            
            <div class="form-section" style="text-align: center;">
                <div class="rating" id="star-rating" style="justify-content: center; font-size: 2.5rem; gap: 10px;">
                    <i class="fa-solid fa-star star" onclick="setRating(1)"></i>
                    <i class="fa-solid fa-star star" onclick="setRating(2)"></i>
                    <i class="fa-solid fa-star star" onclick="setRating(3)"></i>
                    <i class="fa-solid fa-star star" onclick="setRating(4)"></i>
                    <i class="fa-solid fa-star star" onclick="setRating(5)"></i>
                </div>
                <p id="rating-text" style="margin-top: 10px; color: #64748B; font-size: 0.9rem;">Tap to rate</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">Share your experience (Optional)</label>
                <textarea id="rating-comment" class="inp" placeholder="Tell us what you liked or how we can improve..." rows="4" style="resize: none;"></textarea>
            </div>
            
            <button class="btn" onclick="submitRating()" id="submit-rating-btn" style="background: #F59E0B;">
                <i class="fa-solid fa-paper-plane"></i> Submit Rating
            </button>
        </div>
    </div>

    <!-- AI CHAT FULL SHEET -->
    <div class="full-sheet" id="fs-ai-chat">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-ai-chat')"></i>
            <span><i class="fa-solid fa-robot" style="margin-right: 8px;"></i>UrbanPaintPro AI</span>
        </div>
        <div class="fs-body" style="display: flex; flex-direction: column; padding: 0;">
            <div id="ai-chat-box" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #F8FAFC;">
                <div class="chat-msg chat-ai">Hello! I'm UrbanPaintPro AI. I can help you with pricing, booking, and any questions about our painting services. How can I assist you today?</div>
            </div>
            <div class="chat-input" style="padding: 15px; background: white; border-top: 1px solid #E2E8F0;">
                <input type="text" id="ai-chat-in" class="inp" style="margin: 0; background: #F8FAFC;" placeholder="Type your message..." onkeypress="handleAIChat(event)">
                <button onclick="sendAIChat()" style="background: var(--p); color: white; border: none; width: 50px; border-radius: 12px; height: 50px; cursor: pointer; flex-shrink: 0;">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ADD ADDRESS FULL SHEET -->
    <div class="full-sheet" id="fs-add-address">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-add-address')"></i>
            <span>Add New Address</span>
        </div>
        <div class="fs-body">
            <div class="form-section">
                <label class="form-label">Complete Address</label>
                <textarea id="new-address-input" class="inp" placeholder="House/Flat No, Building, Street, Area, Landmark" rows="3" style="resize: none;"></textarea>
                
                <label class="form-label" style="margin-top: 15px;">City</label>
                <input type="text" id="new-address-city" class="inp" placeholder="City name">
                
                <label class="form-label" style="margin-top: 15px;">Pincode</label>
                <input type="text" id="new-address-pin" class="inp" placeholder="6-digit pincode" maxlength="6">
            </div>
            
            <button class="btn" onclick="saveNewAddress()" id="save-address-btn">
                <i class="fa-solid fa-save"></i> Save Address
            </button>
        </div>
    </div>

    <!-- ==================== MAIN PAGES ==================== -->

    <div class="page active" id="home">
        <div style="margin-bottom: 20px;">
            <h2 style="color: var(--p);">Namaste! üôè</h2>
            <p style="color: #64748B;">Apne ghar ko naya rang dein.</p>
        </div>
    
        <div class="card">
            <h3 style="margin-bottom: 15px;">Paint Cost Calculator</h3>
            
            <div class="input-group">
                <label class="merged-label">Select City</label>
                <select id="citySel" class="inp" onchange="setCity()">
                    <option value="delhi">Delhi</option>
                    <option value="noida">Noida</option>
                    <option value="gurgaon">Gurgaon</option>
                </select>
            </div>
    
            <div class="merged-section">
                <div class="input-group">
                    <label class="merged-label">Select Brand</label>
                    <select id="brand-sel" class="inp" onchange="loadCats()">
                        <option value="Asian">Asian Paints</option>
                        <option value="Berger">Berger Paints</option>
                        <option value="Nerolac">Nerolac</option>
                        <option value="Dulux">Dulux</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label class="merged-label">Category</label>
                    <select id="cat-sel" class="inp" onchange="loadProds()"></select>
                </div>
    
                <div class="input-group">
                    <label class="merged-label">Product</label>
                    <select id="prod-sel" class="inp" onchange="calc()"></select>
                </div>
            </div>
    
            <div class="input-group">
                <label class="merged-label" data-lang="scope">Select Scope</label>
                <select id="scope-sel" class="inp" onchange="calc()">
                    <option value="1">Fresh Painting (2 Coats + Putty)</option>
                    <option value="0.8">Repaint (2 Coats)</option>
                    <option value="0.5">Rental Painting (1 Coat)</option>
                    <option value="0.3">Touch Up</option>
                </select>
            </div>
    
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; background: #F8FAFC; padding: 15px; border-radius: 12px;">
                <div>
                    <span style="color: #64748B; font-size: 0.9rem;" data-lang="qty">Unit Count</span>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        <button onclick="updateQty(-1)" style="width: 30px; height: 30px; border-radius: 8px; border: 1px solid #ccc; background: white;">-</button>
                        <strong id="qty-val">1</strong>
                        <button onclick="updateQty(1)" style="width: 30px; height: 30px; border-radius: 8px; border: 1px solid #ccc; background: white;">+</button>
                    </div>
                </div>
                <div style="text-align: right;">
                    <span style="color: #64748B; font-size: 0.9rem;" data-lang="est">Estimated Price</span>
                    <h2 id="total-price" style="color: var(--p);">‚Çπ0</h2>
                </div>
            </div>
    
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn outline" onclick="genInvoice()" style="flex: 1;">
                    <i class="fa-solid fa-file-invoice"></i> Bill
                </button>
                <button class="btn" onclick="startBooking()" style="flex: 1;">
                    Book Visit
                </button>
            </div>
        </div>
    </div>
    
    <div class="page" id="orders">
        <h2 style="margin-bottom: 20px;">My Bookings</h2>
        <div id="order-loading" style="text-align: center; display: none;">
            <div class="btn-loading" style="width: 40px; height: 40px; margin: 0 auto;"></div>
        </div>
        <div id="order-list"></div>
    </div>
    
    <div class="page" id="account">
        <div style="margin-bottom: 20px;">
            <div id="auth-ui" style="text-align: center; padding: 25px; background: #EEF2FF; border-radius: 16px; border: 1px dashed var(--p);">
                <i class="fa-solid fa-user-lock" style="font-size: 2rem; color: var(--p); margin-bottom: 10px;"></i>
                <h3>Login to UrbanPaintPro</h3>
                <p style="margin-bottom: 15px; color: #64748B; font-size: 0.9rem;">Track orders, get discounts & manage profile</p>
                <button class="btn" onclick="openFS('fs-login')">Login / Signup</button>
            </div>
    
            <div id="profile-ui" style="display: none;">
                <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div id="avatar" style="width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">U</div>
                    <div style="flex: 1;">
                        <h3 id="u-name" style="margin-bottom: 2px;">User</h3>
                        <p id="u-email" style="font-size: 0.8rem; color: #64748B; word-break: break-all;">user@example.com</p>
                        <div id="u-plan-badge" style="margin-top: 5px;"></div>
                    </div>
                    <i class="fa-solid fa-pen-to-square" onclick="openFS('fs-personal')" style="color: var(--p); cursor: pointer; padding: 5px;"></i>
                </div>
    
                <div class="card" style="padding: 0; margin-bottom: 20px;">
                    <div class="menu-item" onclick="openFS('fs-plans')">
                        <i class="fa-solid fa-crown" style="color: #F59E0B;"></i>
                        <span>Membership Plans</span>
                        <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: #cbd5e1;"></i>
                    </div>
                    <div class="menu-item" onclick="openFS('fs-addresses')">
                        <i class="fa-solid fa-map-location-dot" style="color: var(--p);"></i>
                        <span>Saved Addresses</span>
                        <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: #cbd5e1;"></i>
                    </div>
                    <div class="menu-item" onclick="openFS('fs-language')">
                        <i class="fa-solid fa-language" style="color: var(--info);"></i>
                        <span data-lang="language">Language / ‡§≠‡§æ‡§∑‡§æ</span>
                        <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: #cbd5e1;"></i>
                    </div>
                    <div class="menu-item">
                        <i class="fa-solid fa-moon" style="color: #64748B;"></i>
                        <span>Dark Mode</span>
                        <label class="switch">
                            <input type="checkbox" id="dark-toggle" onchange="toggleDarkMode()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="menu-item" onclick="logout()" style="border-top: 1px solid #F1F5F9;">
                        <i class="fa-solid fa-arrow-right-from-bracket" style="color: var(--error);"></i>
                        <span style="color: var(--error);">Logout</span>
                    </div>
                </div>

                <!-- HELP CENTER SECTION -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-headset" style="color: var(--p);"></i>
                        Help Center
                    </h3>
                    
                    <div class="help-item ai" onclick="openFS('fs-ai-chat')">
                        <div class="help-icon ai">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div class="help-info">
                            <div class="help-title">UrbanPaintPro AI</div>
                            <div class="help-subtitle">Get instant answers 24/7</div>
                        </div>
                        <i class="fa-solid fa-chevron-right" style="color: #C7D2FE;"></i>
                    </div>
                    
                    <a href="https://wa.me/919711904092" target="_blank" class="help-item whatsapp">
                        <div class="help-icon whatsapp">
                            <i class="fa-brands fa-whatsapp"></i>
                        </div>
                        <div class="help-info">
                            <div class="help-title">WhatsApp Support</div>
                            <div class="help-subtitle">+91 9711904092</div>
                        </div>
                        <i class="fa-solid fa-external-link-alt" style="color: #86EFAC;"></i>
                    </a>
                    
                    <a href="mailto:urbanpaintpro.index@gmail.com" class="help-item email">
                        <div class="help-icon email">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        <div class="help-info">
                            <div class="help-title">Email Support</div>
                            <div class="help-subtitle">urbanpaintpro.index@gmail.com</div>
                        </div>
                        <i class="fa-solid fa-external-link-alt" style="color: #FECACA;"></i>
                    </a>
                </div>

                <!-- LEGAL & SERVICES SECTION -->
                <div class="card" style="padding: 0; margin-bottom: 20px;">
                    <div class="menu-item" onclick="openFS('fs-legal')">
                        <i class="fa-solid fa-scale-balanced" style="color: #8B5CF6;"></i>
                        <span>Legal Policies</span>
                        <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: #cbd5e1;"></i>
                    </div>
                    <div class="menu-item" onclick="openFS('fs-warranty')">
                        <i class="fa-solid fa-shield-halved" style="color: #10B981;"></i>
                        <span>Digital Warranty Tracker</span>
                        <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: #cbd5e1;"></i>
                    </div>
                    <div class="menu-item" onclick="openFS('fs-amc')">
                        <i class="fa-solid fa-screwdriver-wrench" style="color: #F59E0B;"></i>
                        <span>Annual Maintenance Contract (AMC)</span>
                        <i class="fa-solid fa-chevron-right" style="font-size: 0.8rem; color: #cbd5e1;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="page" id="notifications">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Notifications</h2>
            <div style="background: #F1F5F9; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #64748B;">
                <i class="fa-solid fa-check-double"></i> Mark all read
            </div>
        </div>
        
        <div id="notification-list">
            <div style="text-align: center; padding: 50px 20px; opacity: 0.5;">
                <i class="fa-regular fa-bell" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>No new notifications</p>
            </div>
        </div>
    </div>
    
    <!-- BOTTOM NAVIGATION -->
    <div class="nav">
        <div class="nav-item active" onclick="nav('home', this)">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="nav('orders', this)">
            <i class="fa-solid fa-box-open"></i>
            <span>Orders</span>
        </div>
        <div class="nav-item" onclick="nav('account', this)">
            <i class="fa-solid fa-user"></i>
            <span>Account</span>
        </div>
    </div>

    <!-- PERSONAL INFO FULL SHEET -->
    <div id="fs-personal" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-personal')"></i>
            <span>Edit Profile</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: #E2E8F0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 2rem; color: #64748B;">
                    <i class="fa-solid fa-camera"></i>
                </div>
                <p style="font-size: 0.8rem; color: var(--p); margin-top: 5px;">Change Photo</p>
            </div>
            
            <div class="form-section">
                <label class="form-label">Display Name</label>
                <input type="text" id="edit-name" class="inp" placeholder="Your Name">
                
                <label class="form-label" style="margin-top: 15px;">Email (Read Only)</label>
                <input type="email" id="edit-email" class="inp" readonly style="background: #F1F5F9;">
                
                <label class="form-label" style="margin-top: 15px;">Phone Number</label>
                <input type="tel" id="edit-phone" class="inp" placeholder="+91...">
            </div>
            
            <button class="btn" onclick="saveProfile()" style="margin-top: 20px;">Save Changes</button>
        </div>
    </div>
    
    <!-- ADDRESSES FULL SHEET -->
    <div id="fs-addresses" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-addresses')"></i>
            <span>Saved Addresses</span>
        </div>
        <div class="fs-body">
            <div id="address-list">
                <p style="text-align: center; color: #94A3B8; margin-top: 50px;">No addresses saved yet.</p>
            </div>
            <button class="btn outline" onclick="openFS('fs-add-address')" style="margin-top: 20px;">
                <i class="fa-solid fa-plus"></i> Add New Address
            </button>
        </div>
    </div>
    
    <!-- PLANS FULL SHEET -->
    <div id="fs-plans" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-plans')"></i>
            <span>Membership Plans</span>
        </div>
        <div class="fs-body" id="fs-plans-content">
            <div class="card" style="border: 2px solid #E2E8F0; margin-bottom: 15px;">
                <h3>Free Plan</h3>
                <p style="color: #64748B; font-size: 0.9rem;">Basic access to services</p>
                <h2 style="margin: 10px 0;">‚Çπ0 <span style="font-size: 0.9rem; font-weight: 400;">/ life</span></h2>
                <button class="btn outline" disabled>Current Plan</button>
            </div>
            
            <div class="card" style="border: 2px solid #F59E0B; background: #FFFBEB;">
                <div style="display: flex; justify-content: space-between;">
                    <h3>Pro Member</h3>
                    <span style="background: #F59E0B; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">RECOMMENDED</span>
                </div>
                <ul style="margin: 15px 0 15px 20px; color: #4B5563; font-size: 0.9rem;">
                    <li>Priority Support</li>
                    <li>5% Discount on Painting</li>
                    <li>Free Color Consultation</li>
                </ul>
                <h2 style="margin: 10px 0;">‚Çπ499 <span style="font-size: 0.9rem; font-weight: 400;">/ year</span></h2>
                <button class="btn" style="background: #F59E0B;" onclick="buyPlan('pro')">Upgrade to Pro</button>
            </div>
        </div>
    </div>
    
    <!-- LANGUAGE FULL SHEET -->
    <div id="fs-language" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-language')"></i>
            <span>Language / ‡§≠‡§æ‡§∑‡§æ</span>
        </div>
        <div class="fs-body">
            <div class="menu-item" onclick="setLang('en', true)">
                <span>English</span>
                <i class="fa-solid fa-check" id="lang-check-en" style="color: var(--success);"></i>
            </div>
            <div class="menu-item" onclick="setLang('hi', true)">
                <span>‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</span>
                <i class="fa-solid fa-check" id="lang-check-hi" style="display: none; color: var(--success);"></i>
            </div>
        </div>
    </div>

    <!-- LEGAL POLICIES FULL SHEET -->
    <div id="fs-legal" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-legal')"></i>
            <span><i class="fa-solid fa-scale-balanced" style="margin-right: 10px;"></i>Legal Policies</span>
        </div>
        <div class="fs-body">
            <div class="form-section">
                <h3 style="color: var(--p); margin-bottom: 15px;">Terms of Service</h3>
                <div style="line-height: 1.8; color: #444; font-size: 0.9rem;">
                    <p style="margin-bottom: 10px;"><strong>1. Service Agreement:</strong> By booking our services, you agree to our terms and conditions.</p>
                    <p style="margin-bottom: 10px;"><strong>2. Payment Terms:</strong> 50% advance payment required to confirm booking. Balance due on completion.</p>
                    <p style="margin-bottom: 10px;"><strong>3. Cancellation:</strong> Free cancellation up to 24 hours before scheduled service.</p>
                    <p style="margin-bottom: 10px;"><strong>4. Material Quality:</strong> We use only branded, genuine paints and materials.</p>
                </div>
            </div>
            
            <div class="form-section">
                <h3 style="color: var(--p); margin-bottom: 15px;">Privacy Policy</h3>
                <div style="line-height: 1.8; color: #444; font-size: 0.9rem;">
                    <p style="margin-bottom: 10px;"><strong>1. Data Collection:</strong> We collect only necessary information for service delivery.</p>
                    <p style="margin-bottom: 10px;"><strong>2. Data Security:</strong> Your personal information is encrypted and securely stored.</p>
                    <p style="margin-bottom: 10px;"><strong>3. Third Party:</strong> We do not share your data with unauthorized third parties.</p>
                </div>
            </div>
            
            <div class="form-section">
                <h3 style="color: var(--p); margin-bottom: 15px;">Refund Policy</h3>
                <div style="line-height: 1.8; color: #444; font-size: 0.9rem;">
                    <p style="margin-bottom: 10px;"><strong>1. Before Work:</strong> Full refund if cancelled 24 hours before service.</p>
                    <p style="margin-bottom: 10px;"><strong>2. During Work:</strong> Proportional refund based on work completed.</p>
                    <p style="margin-bottom: 10px;"><strong>3. After Work:</strong> No refund after project completion.</p>
                </div>
            </div>
            
            <div class="form-section" style="background: #EEF2FF; border: 1px solid #C7D2FE;">
                <h4 style="color: var(--p); margin-bottom: 10px;"><i class="fa-solid fa-circle-info"></i> Need Help?</h4>
                <p style="font-size: 0.9rem; color: #64748B;">Contact our support team for any legal queries:</p>
                <p style="font-size: 0.9rem; margin-top: 5px;"><i class="fa-brands fa-whatsapp" style="color: #25D366;"></i> +91 9711904092</p>
                <p style="font-size: 0.9rem;"><i class="fa-solid fa-envelope" style="color: #EA4335;"></i> urbanpaintpro.index@gmail.com</p>
            </div>
        </div>
    </div>

    <!-- DIGITAL WARRANTY TRACKER FULL SHEET -->
    <div id="fs-warranty" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-warranty')"></i>
            <span><i class="fa-solid fa-shield-halved" style="margin-right: 10px;"></i>Digital Warranty Tracker</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-shield-halved" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h2 style="margin-top: 15px;">Your Warranties</h2>
                <p style="color: #64748B; font-size: 0.9rem;">Track and manage your service warranties</p>
            </div>
            
            <div id="warranty-list">
                <!-- Warranty cards will be dynamically loaded here -->
                <div class="form-section" style="text-align: center; padding: 40px 20px;">
                    <i class="fa-solid fa-clipboard-check" style="font-size: 3rem; color: #E2E8F0; margin-bottom: 15px;"></i>
                    <p style="color: #64748B;">No active warranties found</p>
                    <p style="font-size: 0.85rem; color: #94A3B8; margin-top: 5px;">Complete a painting service to get warranty coverage</p>
                </div>
            </div>
            
            <div class="form-section" style="background: #F0FDF4; border: 1px solid #86EFAC;">
                <h4 style="color: #166534; margin-bottom: 10px;"><i class="fa-solid fa-circle-info"></i> Warranty Coverage</h4>
                <ul style="font-size: 0.9rem; color: #166534; padding-left: 20px; line-height: 1.8;">
                    <li>1 Year warranty on all painting services</li>
                    <li>Free touch-ups for peeling/cracking</li>
                    <li>Color fading protection</li>
                    <li>Waterproofing defect coverage</li>
                </ul>
            </div>
            
            <div class="form-section">
                <h4 style="color: var(--p); margin-bottom: 15px;">Claim Warranty</h4>
                <label class="form-label">Order ID</label>
                <input type="text" id="warranty-order-id" class="inp" placeholder="Enter your order ID">
                
                <label class="form-label" style="margin-top: 15px;">Issue Description</label>
                <textarea id="warranty-issue" class="inp" placeholder="Describe the issue you're facing..." rows="3" style="resize: none;"></textarea>
                
                <button class="btn" onclick="submitWarrantyClaim()" style="margin-top: 15px;">
                    <i class="fa-solid fa-paper-plane"></i> Submit Claim
                </button>
            </div>
        </div>
    </div>

    <!-- AMC FULL SHEET -->
    <div id="fs-amc" class="full-sheet">
        <div class="fs-header">
            <i class="fa-solid fa-arrow-left" onclick="closeFS('fs-amc')"></i>
            <span><i class="fa-solid fa-screwdriver-wrench" style="margin-right: 10px;"></i>Annual Maintenance Contract</span>
        </div>
        <div class="fs-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #F59E0B, #D97706); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-screwdriver-wrench" style="font-size: 2.5rem; color: white;"></i>
                </div>
                <h2 style="margin-top: 15px;">AMC Plans</h2>
                <p style="color: #64748B; font-size: 0.9rem;">Keep your home looking fresh year-round</p>
            </div>
            
            <!-- AMC Plans -->
            <div class="card" style="border: 2px solid #E2E8F0; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: #374151;">Basic AMC</h3>
                        <p style="font-size: 0.9rem; color: #64748B; margin: 5px 0;">For 1 BHK / Small Spaces</p>
                    </div>
                    <h2 style="color: var(--p);">‚Çπ1,999<span style="font-size: 0.8rem; font-weight: 400;">/year</span></h2>
                </div>
                <ul style="margin: 15px 0 0 20px; color: #4B5563; font-size: 0.9rem; line-height: 1.8;">
                    <li>2 Preventive maintenance visits</li>
                    <li>Free touch-ups (up to 50 sqft)</li>
                    <li>Priority service scheduling</li>
                    <li>10% discount on repainting</li>
                </ul>
                <button class="btn outline" onclick="buyAMC('basic')" style="margin-top: 15px;">Subscribe</button>
            </div>
            
            <div class="card" style="border: 2px solid #F59E0B; background: #FFFBEB; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: #92400E;">Standard AMC</h3>
                        <p style="font-size: 0.9rem; color: #A16207; margin: 5px 0;">For 2-3 BHK / Medium Spaces</p>
                    </div>
                    <span style="background: #F59E0B; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem;">POPULAR</span>
                </div>
                <div style="text-align: right; margin-top: -30px;">
                    <h2 style="color: #92400E;">‚Çπ3,999<span style="font-size: 0.8rem; font-weight: 400;">/year</span></h2>
                </div>
                <ul style="margin: 15px 0 0 20px; color: #4B5563; font-size: 0.9rem; line-height: 1.8;">
                    <li>4 Preventive maintenance visits</li>
                    <li>Free touch-ups (up to 150 sqft)</li>
                    <li>Priority service scheduling</li>
                    <li>15% discount on repainting</li>
                    <li>Free color consultation</li>
                </ul>
                <button class="btn" onclick="buyAMC('standard')" style="background: #F59E0B; margin-top: 15px;">Subscribe</button>
            </div>
            
            <div class="card" style="border: 2px solid #8B5CF6; background: linear-gradient(135deg, #F5F3FF, #FFFFFF);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: #5B21B6;">Premium AMC</h3>
                        <p style="font-size: 0.9rem; color: #7C3AED; margin: 5px 0;">For 4+ BHK / Large Spaces</p>
                    </div>
                    <span style="background: #8B5CF6; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem;">BEST VALUE</span>
                </div>
                <div style="text-align: right; margin-top: -30px;">
                    <h2 style="color: #5B21B6;">‚Çπ7,999<span style="font-size: 0.8rem; font-weight: 400;">/year</span></h2>
                </div>
                <ul style="margin: 15px 0 0 20px; color: #4B5563; font-size: 0.9rem; line-height: 1.8;">
                    <li>6 Preventive maintenance visits</li>
                    <li>Free touch-ups (up to 300 sqft)</li>
                    <li>VIP priority service (same day)</li>
                    <li>25% discount on repainting</li>
                    <li>Free color consultation</li>
                    <li>Annual deep cleaning included</li>
                </ul>
                <button class="btn" onclick="buyAMC('premium')" style="background: #8B5CF6; margin-top: 15px;">Subscribe</button>
            </div>
            
            <div class="form-section" style="background: #FEF3C7; border: 1px solid #FDE68A; margin-top: 20px;">
                <h4 style="color: #92400E; margin-bottom: 10px;"><i class="fa-solid fa-lightbulb"></i> Why AMC?</h4>
                <p style="font-size: 0.9rem; color: #78350F; line-height: 1.6;">Regular maintenance extends the life of your paint by 2-3 years and keeps your home looking fresh. Save up to 40% compared to ad-hoc repairs!</p>
            </div>
        </div>
    </div>

    <!-- SUCCESS STATUS SCREEN -->
    <div id="status-success" class="status-screen">
        <div class="icon-circle success-icon">
            <i class="fa-solid fa-check"></i>
        </div>
        <h2 style="margin-bottom: 10px;">Booking Confirmed!</h2>
        <p id="success-message" style="color: #64748B; margin-bottom: 30px;">Your booking has been confirmed!</p>
        <button class="btn" onclick="closeStatus()" style="width: 200px;">Continue</button>
    </div>

    <script>
        // ==================== CONFIGURATION & STATE ====================
        const UrbanPaintPro = {
            currentQty: 1,
            userPlanDetails: { name: "Free User", status: "none" },
            currentLang: localStorage.getItem('language') || 'en',
            currentCity: localStorage.getItem("city") || "delhi",
            currentService: 'painting',
            pendingPayment: null,
            uploadedImages: [],
            currentRating: 0,
            currentRatingOrder: null,
            listeners: [],
            deferredPrompt: null,
            isOnline: navigator.onLine
        };

        // City Configuration
        const citySurge = {
            delhi: 1.2,
            gurgaon: 1.3,
            noida: 1.25,
            faridabad: 1.15,
            ghaziabad: 1.1
        };

        // 7 Languages Dictionary
        const dict = {
            en: { work_area: "Define Work Area", scope: "Select Scope", qty: "Unit Count", paint_sel: "Paint Selection", est: "Estimated Price", bill: "Download Bill", book_visit: "Book Inspection Visit", projects: "My Projects", language: "Language / ‡§≠‡§æ‡§∑‡§æ" },
            hi: { work_area: "‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç", scope: "‡§¶‡§æ‡§Ø‡§∞‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç", qty: "‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ", paint_sel: "‡§™‡•á‡§Ç‡§ü ‡§ö‡•Å‡§®‡•á‡§Ç", est: "‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§ï‡•Ä‡§Æ‡§§", bill: "‡§¨‡§ø‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç", book_visit: "‡§á‡§Ç‡§∏‡•ç‡§™‡•á‡§ï‡•ç‡§∂‡§® ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç", projects: "‡§Æ‡•á‡§∞‡•á ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü‡•ç‡§∏", language: "‡§≠‡§æ‡§∑‡§æ / Language" },
            hing: { work_area: "Work Area Select Karo", scope: "Scope Chunen", qty: "Kitne Rooms?", paint_sel: "Paint Select Karo", est: "Lagbhag Price", bill: "Bill Download Karo", book_visit: "Book Now", projects: "Mere Orders", language: "Bhasha Badlein" },
            mr: { work_area: "‡§ï‡§æ‡§Æ‡§æ‡§ö‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§®‡§ø‡§µ‡§°‡§æ", scope: "‡§µ‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡•Ä", qty: "‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ", paint_sel: "‡§∞‡§Ç‡§ó ‡§®‡§ø‡§µ‡§°‡§æ", est: "‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§ï‡§ø‡§Ç‡§Æ‡§§", bill: "‡§¨‡§ø‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ", book_visit: "‡§≠‡•á‡§ü ‡§¨‡•Å‡§ï ‡§ï‡§∞‡§æ", projects: "‡§Æ‡§æ‡§ù‡•á ‡§™‡•ç‡§∞‡§ï‡§≤‡•ç‡§™", language: "‡§≠‡§æ‡§∑‡§æ" },
            bn: { work_area: "‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ", scope: "‡¶™‡¶∞‡¶ø‡¶ß‡¶ø", qty: "‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ", paint_sel: "‡¶™‡ßá‡¶á‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®", est: "‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶¶‡¶æ‡¶Æ", bill: "‡¶¨‡¶ø‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°", book_visit: "‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®", projects: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™", language: "‡¶≠‡¶æ‡¶∑‡¶æ" },
            ta: { work_area: "‡Æµ‡Øá‡Æ≤‡Øà ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Øà ‡Æµ‡Æ∞‡Øà‡ÆØ‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", scope: "‡Æ®‡Øã‡Æï‡Øç‡Æï‡ÆÆ‡Øç", qty: "‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æï‡Øç‡Æï‡Øà", paint_sel: "‡Æ™‡ØÜ‡ÆØ‡Æø‡Æ£‡Øç‡Æü‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ", est: "‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æ≤‡Øà", bill: "‡Æ™‡Æø‡Æ≤‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", book_visit: "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ", projects: "‡Æ§‡Æø‡Æü‡Øç‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç", language: "‡ÆÆ‡Øä‡Æ¥‡Æø" },
            te: { work_area: "‡∞™‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç", scope: "‡∞™‡∞∞‡∞ø‡∞ß‡∞ø", qty: "‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø", paint_sel: "‡∞™‡±Ü‡∞Ø‡∞ø‡∞Ç‡∞ü‡±ç ‡∞é‡∞Ç‡∞™‡∞ø‡∞ï", est: "‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ ‡∞ß‡∞∞", bill: "‡∞¨‡∞ø‡∞≤‡±ç ‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç", book_visit: "‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø", projects: "‡∞™‡±ç‡∞∞‡∞æ‡∞ú‡±Ü‡∞ï‡±ç‡∞ü‡±Å‡∞≤‡±Å", language: "‡∞≠‡∞æ‡∞∑" }
        };

        // Expanded Product Catalog
        const catalog = {
            "Asian": { 
                "Interior": [{n: "Tractor Emulsion", p: 12}, {n: "Apcolite Premium", p: 20}, {n: "Royale Luxury", p: 26}, {n: "Royale Aspira", p: 35}], 
                "Exterior": [{n: "Ace Exterior", p: 15}, {n: "Apex Ultima", p: 30}, {n: "Apex Weatherproof", p: 25}],
                "Waterproofing": [{n: "Damp Block", p: 80}, {n: "Crack Fill", p: 110}, {n: "SmartCare", p: 95}],
                "Wood/Metal": [{n: "Enamel", p: 18}, {n: "PU Gloss", p: 150}, {n: "Melamyne", p: 120}]
            },
            "Berger": { 
                "Interior": [{n: "Bison Emulsion", p: 13}, {n: "Silk Glamor", p: 28}, {n: "Easy Clean", p: 22}], 
                "Exterior": [{n: "Walmasta", p: 16}, {n: "Weathercoat", p: 35}, {n: "Silk", p: 28}],
                "Waterproofing": [{n: "Home Shield", p: 85}, {n: "Damp Stop", p: 90}],
                "Wood/Metal": [{n: "Luxol", p: 20}, {n: "Imperia", p: 140}, {n: "PU", p: 160}]
            },
            "Nerolac": {
                "Interior": [{n: "Beauty Smooth", p: 14}, {n: "Pearls", p: 24}, {n: "Impressions", p: 30}],
                "Exterior": [{n: "Excel", p: 18}, {n: "Suraksha", p: 22}],
                "Waterproofing": [{n: "Damp Proof", p: 75}],
                "Wood/Metal": [{n: "Synthetic Enamel", p: 16}]
            },
            "Dulux": {
                "Interior": [{n: "SuperCover", p: 16}, {n: "Velvet Touch", p: 32}, {n: "Promise", p: 22}],
                "Exterior": [{n: "Weathershield", p: 28}, {n: "Total", p: 20}],
                "Waterproofing": [{n: "Damp Proof", p: 88}],
                "Wood/Metal": [{n: "WoodShield", p: 130}]
            }
        };

        // ==================== FIREBASE INITIALIZATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
            authDomain: "urban-paint-pro.firebaseapp.com",
            databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "urban-paint-pro",
            storageBucket: "urban-paint-pro.firebasestorage.app",
            messagingSenderId: "929763117480",
            appId: "1:929763117480:web:560057baeb12672078b59d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();
        let messaging = null;
        
        // Initialize Messaging if supported
        if ('Notification' in window && 'serviceWorker' in navigator) {
            try {
                messaging = firebase.messaging();
            } catch (e) {
                console.log('Messaging not supported');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        // Toast Notification System
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-xmark-circle',
                warning: 'fa-triangle-exclamation',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fa-solid ${icons[type]}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Loading State Toggle
        function setLoading(elementId, isLoading, text = null) {
            const btn = document.getElementById(elementId);
            if (!btn) return;
            
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
                if (text) btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = text || '';
            } else {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
                if (btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
            }
        }

        // Input Validation Functions
        function validateEmail(input) {
            const email = input.value.trim();
            const error = document.getElementById(input.id + '-error');
            const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            
            if (error) {
                if (email && !isValid) {
                    error.classList.add('show');
                    input.style.borderColor = 'var(--error)';
                } else {
                    error.classList.remove('show');
                    input.style.borderColor = '';
                }
            }
            return isValid;
        }

        function validatePassword(input) {
            const pass = input.value;
            const error = document.getElementById(input.id + '-error');
            const isValid = pass.length >= 6;
            
            if (error) {
                if (pass && !isValid) {
                    error.classList.add('show');
                    input.style.borderColor = 'var(--error)';
                } else {
                    error.classList.remove('show');
                    input.style.borderColor = '';
                }
            }
            return isValid;
        }

        function validateName(input) {
            const name = input.value.trim();
            const error = document.getElementById(input.id + '-error');
            const isValid = name.length >= 2;
            
            if (error) {
                if (name && !isValid) {
                    error.classList.add('show');
                    input.style.borderColor = 'var(--error)';
                } else {
                    error.classList.remove('show');
                    input.style.borderColor = '';
                }
            }
            return isValid;
        }

        function validatePhone(input) {
            const phone = input.value.trim();
            const error = document.getElementById(input.id + '-error');
            const isValid = /^[6-9]\d{9}$/.test(phone);
            
            if (error) {
                if (phone && !isValid) {
                    error.classList.add('show');
                    input.style.borderColor = 'var(--error)';
                } else {
                    error.classList.remove('show');
                    input.style.borderColor = '';
                }
            }
            return isValid;
        }

        function validatePincode(input) {
            const pin = input.value.trim();
            const error = document.getElementById('pin-error');
            const isValid = /^\d{6}$/.test(pin);
            
            if (error) {
                if (pin && !isValid) {
                    error.classList.add('show');
                    input.style.borderColor = 'var(--error)';
                } else {
                    error.classList.remove('show');
                    input.style.borderColor = '';
                }
            }
            return isValid;
        }

        function validateUTR(input) {
            const utr = input.value.trim();
            const error = document.getElementById('utr-error');
            const isValid = /^\d{12}$/.test(utr);
            
            if (error) {
                if (utr && !isValid) {
                    error.classList.add('show');
                } else {
                    error.classList.remove('show');
                }
            }
            return isValid;
        }

        // Sanitize Input (XSS Prevention)
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // ==================== PWA & SERVICE WORKER ====================
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                self.addEventListener('install', e => {
                    e.waitUntil(
                        caches.open('urbanpaint-v3').then(cache => {
                            return cache.addAll([
                                '/',
                                '/index.html'
                            ]);
                        })
                    );
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', e => {
                    e.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames
                                    .filter(name => name !== 'urbanpaint-v3')
                                    .map(name => caches.delete(name))
                            );
                        })
                    );
                });
                
                self.addEventListener('fetch', e => {
                    e.respondWith(
                        fetch(e.request).catch(() => {
                            return caches.match(e.request).then(response => {
                                if (response) return response;
                                if (e.request.mode === 'navigate') {
                                    return caches.match('/index.html');
                                }
                            });
                        })
                    );
                });
                
                self.addEventListener('push', e => {
                    const data = e.data.json();
                    e.waitUntil(
                        self.registration.showNotification(data.title, {
                            body: data.body,
                            icon: 'assets/logo.png',
                            badge: 'assets/logo.png',
                            data: data.url
                        })
                    );
                });
                
                self.addEventListener('notificationclick', e => {
                    e.notification.close();
                    e.waitUntil(clients.openWindow(e.notification.data));
                });
            `)).then(reg => {
                console.log('Service Worker registered');
            }).catch(err => {
                console.log('SW registration failed:', err);
            });
        }

        // Install Prompt
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            UrbanPaintPro.deferredPrompt = e;
            setTimeout(() => {
                document.getElementById('install-prompt').style.display = 'flex';
            }, 3000);
        });

        function installApp() {
            if (UrbanPaintPro.deferredPrompt) {
                UrbanPaintPro.deferredPrompt.prompt();
                UrbanPaintPro.deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        showToast('App installed successfully!', 'success');
                    }
                    UrbanPaintPro.deferredPrompt = null;
                    document.getElementById('install-prompt').style.display = 'none';
                });
            }
        }

        // Online/Offline Detection
        window.addEventListener('online', () => {
            UrbanPaintPro.isOnline = true;
            document.getElementById('offline-bar').classList.remove('show');
            showToast('Back online!', 'success');
        });

        window.addEventListener('offline', () => {
            UrbanPaintPro.isOnline = false;
            document.getElementById('offline-bar').classList.add('show');
            showToast('You are offline', 'warning');
        });

        // ==================== CORE FUNCTIONS ====================

        // Initialize App
        document.addEventListener("DOMContentLoaded", () => {
            // Set minimum date for booking
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('slotDate').min = today;
            
            // Initialize city
            const citySel = document.getElementById("citySel");
            if (citySel) citySel.value = UrbanPaintPro.currentCity;
            
            // Initialize language
            setLang(UrbanPaintPro.currentLang, false);
            
            // Hide splash
            setTimeout(() => {
                const splash = document.getElementById("splash");
                if (splash) {
                    splash.style.opacity = "0";
                    setTimeout(() => splash.remove(), 400);
                }
            }, 1500);
            
            // Load initial data
            loadCats();
            calc();
        });

        // Auth State Listener
        auth.onAuthStateChanged(user => {
            if (!user) {
                document.getElementById('auth-ui').style.display = 'block';
                document.getElementById('profile-ui').style.display = 'none';
                return;
            }

            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('profile-ui').style.display = 'block';
            updateUI(user);
            loadRealData(user.email);
            setupUserListeners(user.uid);
            requestNotificationPermission();
        });

        function setupUserListeners(uid) {
            // Clean up old listeners
            UrbanPaintPro.listeners.forEach(listener => listener.off());
            UrbanPaintPro.listeners = [];

            // Plan listener
            const planRef = db.ref('users/' + uid + '/plan');
            planRef.on('value', snap => {
                UrbanPaintPro.userPlanDetails = snap.val() || { name: "Free User", status: "none" };
                updatePlanUI();
            });
            UrbanPaintPro.listeners.push(planRef);

            // Addresses listener
            const addrRef = db.ref('users/' + uid + '/addresses');
            addrRef.on('value', snap => {
                updateAddressList(snap);
            });
            UrbanPaintPro.listeners.push(addrRef);
            
            // Notifications listener
            const notifRef = db.ref('users/' + uid + '/notifications');
            notifRef.on('value', snap => {
                updateNotificationBadge(snap);
            });
            UrbanPaintPro.listeners.push(notifRef);
        }

        function updatePlanUI() {
            const container = document.getElementById('fs-plans-content');
            const badge = document.getElementById('u-plan-badge');
            
            if (UrbanPaintPro.userPlanDetails.name.includes("Member")) {
                badge.innerHTML = `<span style="background:gold; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:bold; color: #92400E;">
                    <i class="fa-solid fa-crown"></i> ${UrbanPaintPro.userPlanDetails.name}
                </span>`;
                container.innerHTML = `
                    <div class="card" style="border: 2px solid gold; background: linear-gradient(135deg, #FEF3C7, #FDE68A);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <i class="fa-solid fa-crown" style="font-size: 2rem; color: #92400E;"></i>
                            <div>
                                <h3 style="color: #92400E; margin: 0;">${UrbanPaintPro.userPlanDetails.name}</h3>
                                <p style="color: #A16207; margin: 5px 0 0 0; font-size: 0.9rem;">Active Membership</p>
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.5); padding: 15px; border-radius: 8px;">
                            <p style="margin: 0; color: #92400E;"><i class="fa-solid fa-calendar"></i> Valid till: ${UrbanPaintPro.userPlanDetails.exp || 'N/A'}</p>
                            <p style="margin: 10px 0 0 0; color: #92400E; font-size: 0.9rem;">
                                <i class="fa-solid fa-check-circle"></i> Free inspection visits<br>
                                <i class="fa-solid fa-check-circle"></i> Priority booking<br>
                                <i class="fa-solid fa-check-circle"></i> Exclusive discounts
                            </p>
                        </div>
                    </div>
                `;
            } else {
                badge.innerHTML = "";
                container.innerHTML = `
                    <div class="card" style="border:2px solid gold; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: #92400E;"><i class="fa-solid fa-crown"></i> Gold</h3>
                                <p style="font-size: 0.9rem; color: #64748B; margin: 5px 0;">‚Çπ399/year</p>
                            </div>
                            <button class="btn" onclick="openUPIPayment('Gold Plan', 399, 'plan')" style="width: auto; padding: 8px 20px;">Buy</button>
                        </div>
                        <ul style="margin: 15px 0 0 0; padding-left: 20px; color: #444; font-size: 0.9rem;">
                            <li>Free inspection visits</li>
                            <li>15% off on all services</li>
                            <li>Priority customer support</li>
                        </ul>
                    </div>
                    <div class="card" style="border:2px solid #0ea5e9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: #0369A1;"><i class="fa-solid fa-gem"></i> Platinum</h3>
                                <p style="font-size: 0.9rem; color: #64748B; margin: 5px 0;">‚Çπ599/year</p>
                            </div>
                            <button class="btn" onclick="openUPIPayment('Platinum Plan', 599, 'plan')" style="width: auto; padding: 8px 20px; background: #0ea5e9;">Buy</button>
                        </div>
                        <ul style="margin: 15px 0 0 0; padding-left: 20px; color: #444; font-size: 0.9rem;">
                            <li>Free inspection visits</li>
                            <li>20% off on all services</li>
                            <li>24/7 priority support</li>
                            <li>Free color consultation</li>
                        </ul>
                    </div>
                `;
            }
        }

        function updateAddressList(snap) {
            const container = document.getElementById('address-list');
            if (snap.exists()) {
                let html = "";
                snap.forEach(child => {
                    const addr = sanitizeInput(child.val());
                    html += `
                        <div class="menu-item" style="align-items: flex-start;">
                            <i class="fa-solid fa-location-dot" style="margin-top: 3px;"></i>
                            <span style="flex: 1; font-size: 0.9rem;">${addr}</span>
                            <i class="fa-solid fa-trash" onclick="deleteAddress('${child.key}')" style="color: var(--error); cursor: pointer; padding: 5px;"></i>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: #9CA3AF;"><small>No saved addresses</small></div>`;
            }
        }

        function updateNotificationBadge(snap) {
            const badge = document.getElementById('notif-badge');
            if (snap.exists()) {
                const unread = Object.values(snap.val()).filter(n => !n.read).length;
                if (unread > 0) {
                    badge.textContent = unread;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
                
                // Update notification list
                const list = document.getElementById('notification-list');
                let html = '';
                const notifs = Object.entries(snap.val()).sort((a, b) => b[1].time - a[1].time);
                notifs.forEach(([key, n]) => {
                    html += `
                        <div class="card" style="margin-bottom: 10px; ${n.read ? '' : 'border-left: 3px solid var(--p);'}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <p style="margin: 0; font-weight: ${n.read ? '400' : '600'}; color: ${n.read ? '#64748B' : '#0F172A'};">${sanitizeInput(n.message)}</p>
                                    <small style="color: #9CA3AF;">${new Date(n.time).toLocaleString()}</small>
                                </div>
                                ${n.read ? '' : '<span style="width: 8px; height: 8px; background: var(--p); border-radius: 50%;"></span>'}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html || '<div style="text-align: center; padding: 40px; color: #9CA3AF;"><i class="fa-regular fa-bell-slash" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No notifications</p></div>';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ==================== UI UPDATE FUNCTIONS ====================
        
        function updateUI(u) {
            const displayName = sanitizeInput(u.displayName || 'User');
            document.getElementById('u-name').innerText = displayName;
            document.getElementById('u-email').innerText = sanitizeInput(u.email);
            document.getElementById('avatar').innerText = displayName[0].toUpperCase();
            
            // Update edit profile fields
            document.getElementById('edit-name').value = displayName;
            document.getElementById('edit-email').value = u.email;
            
            // Load phone if exists
            db.ref('users/' + u.uid + '/profile/phone').once('value').then(snap => {
                if (snap.exists()) {
                    document.getElementById('edit-phone').value = snap.val();
                }
            });
        }
        
        function setCity() {
            UrbanPaintPro.currentCity = document.getElementById("citySel").value;
            localStorage.setItem("city", UrbanPaintPro.currentCity);
            calc();
            showToast(`City changed to ${UrbanPaintPro.currentCity.charAt(0).toUpperCase() + UrbanPaintPro.currentCity.slice(1)}`, 'success');
        }
        
        function selectService(service) {
            UrbanPaintPro.currentService = service;
            document.querySelectorAll('.service-btn').forEach(btn => {
                btn.style.borderColor = '#E2E8F0';
                btn.style.background = 'white';
                btn.querySelector('i').style.color = '#64748B';
            });
            event.currentTarget.style.borderColor = 'var(--p)';
            event.currentTarget.style.background = '#EEF2FF';
            event.currentTarget.querySelector('i').style.color = 'var(--p)';
            
            // Update service type in booking sheet
            document.getElementById('serviceType').value = service;
        }
        
        function updateQty(v) {
            UrbanPaintPro.currentQty = Math.max(1, UrbanPaintPro.currentQty + v);
            document.getElementById('qty-val').innerText = UrbanPaintPro.currentQty;
            calc();
        }
        
        function loadCats() {
            const b = document.getElementById('brand-sel').value;
            const cats = Object.keys(catalog[b]);
            document.getElementById('cat-sel').innerHTML = cats.map(c => `<option value="${c}" style="color: black;">${c}</option>`).join('');
            loadProds();
        }
        
        function loadProds() {
            const b = document.getElementById('brand-sel').value;
            const c = document.getElementById('cat-sel').value;
            const prods = catalog[b][c];
            document.getElementById('prod-sel').innerHTML = prods.map(p => `<option value="${p.p}" style="color: black;">${p.n} - ‚Çπ${p.p}/sqft</option>`).join('');
            calc();
        }
        
        function calc() {
            const p = parseFloat(document.getElementById('prod-sel').value) || 0;
            const scope = parseFloat(document.getElementById('scope-sel').value) || 1;
            const surge = citySurge[UrbanPaintPro.currentCity] || 1;
            
            let area = 1500;
            if (scope === 0.3) area = 450;
            if (scope === 0.1) area = 120;
            if (scope === 0.5) area = 900;
            if (scope === 0.8) area = 1200;
            
            const total = Math.round((p + 8) * UrbanPaintPro.currentQty * area * surge);
            document.getElementById('total-price').innerText = "‚Çπ" + total.toLocaleString('en-IN');
        }
        
        // ==================== BOOKING FLOW ====================
        
        function startBooking() {
            if (!auth.currentUser) {
                openFS('fs-login');
                return;
            }
            
            openFS('fs-tnc');
        }
        
        function acceptTNC() {
            closeFS('fs-tnc');
            
            const isMember = UrbanPaintPro.userPlanDetails && UrbanPaintPro.userPlanDetails.name.includes("Member");
            const chargeText = document.getElementById('visit-charge-display');
            chargeText.innerHTML = isMember 
                ? `<i class="fa-solid fa-check-circle"></i> Visiting Charge: <strike>‚Çπ49</strike> <b style="color: var(--success);">FREE</b> (Member Benefit)`
                : `<i class="fa-solid fa-tag"></i> Visiting Charge: ‚Çπ49`;
            
            openFS('fs-book');
        }
        
        function autoLoc() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported', 'error');
                return;
            }
            
            const btn = event.currentTarget;
            btn.classList.add('btn-loading');
            
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    document.getElementById('b-addr').value = `Lat: ${lat}, Lng: ${lng}`;
                    btn.classList.remove('btn-loading');
                    showToast('Location detected!', 'success');
                    
                    // Try to get address from coordinates (reverse geocoding)
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.display_name) {
                                document.getElementById('b-addr').value = data.display_name;
                            }
                        })
                        .catch(() => {});
                },
                err => {
                    btn.classList.remove('btn-loading');
                    showToast('Location access denied', 'error');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }
        
        function placeOrder() {
            // Validation
            const addr = document.getElementById('b-addr').value.trim();
            const pin = document.getElementById('b-pin').value.trim();
            const date = document.getElementById('slotDate').value;
            
            let hasError = false;
            
            if (!addr) {
                document.getElementById('addr-error').classList.add('show');
                hasError = true;
            } else {
                document.getElementById('addr-error').classList.remove('show');
            }
            
            if (!/^\d{6}$/.test(pin)) {
                document.getElementById('pin-error').classList.add('show');
                hasError = true;
            } else {
                document.getElementById('pin-error').classList.remove('show');
            }
            
            if (!date) {
                document.getElementById('date-error').classList.add('show');
                hasError = true;
            } else if (new Date(date) < new Date().setHours(0,0,0,0)) {
                document.getElementById('date-error').textContent = 'Please select today or a future date';
                document.getElementById('date-error').classList.add('show');
                hasError = true;
            } else {
                document.getElementById('date-error').classList.remove('show');
            }
            
            if (hasError) return;
            
            // Check if member for free visit
            if (UrbanPaintPro.userPlanDetails && UrbanPaintPro.userPlanDetails.name.includes("Member")) {
                confirmOrderDB(0, "Member_Free");
            } else {
                openUPIPayment('Visit Charge', 49, 'booking');
            }
        }
        
        // ==================== PAYMENT SYSTEM ====================
        
        function openUPIPayment(desc, amt, type) {
            UrbanPaintPro.pendingPayment = { desc: desc, amt: amt, type: type };
            document.getElementById('pay-amt-display').innerText = "‚Çπ" + amt;
            document.getElementById('utr-input').value = "";
            document.getElementById('utr-error').classList.remove('show');
            openFS('fs-payment');
        }
        
        function copyUPI() {
            navigator.clipboard.writeText("kingkhan33648@okicici");
            showToast('UPI ID copied to clipboard!', 'success');
        }
        
        function verifyPayment() {
            const utr = document.getElementById('utr-input').value.trim();
            
            if (!/^\d{12}$/.test(utr)) {
                document.getElementById('utr-error').classList.add('show');
                return;
            }
            
            setLoading('verify-payment-btn', true);
            
            // Simulate verification delay
            setTimeout(() => {
                setLoading('verify-payment-btn', false);
                closeFS('fs-payment');
                
                if (UrbanPaintPro.pendingPayment.type === 'booking') {
                    confirmOrderDB(UrbanPaintPro.pendingPayment.amt, "UPI-" + utr);
                } else if (UrbanPaintPro.pendingPayment.type === 'plan') {
                    activatePlan(UrbanPaintPro.pendingPayment.desc.replace(' Plan', ''), "UPI-" + utr);
                } else if (UrbanPaintPro.pendingPayment.type === 'amc') {
                    verifyAMCPayment(utr);
                }
            }, 2000);
        }
        
        function confirmOrderDB(amt, payId) {
            const user = auth.currentUser;
            if (!user) {
                showToast('Please login first', 'error');
                return;
            }
            
            setLoading('place-order-btn', true);
            
            const orderData = {
                user: user.email,
                userId: user.uid,
                userName: user.displayName || 'Guest',
                serviceType: document.getElementById('serviceType').value,
                scope: document.getElementById('scope-sel').options[document.getElementById('scope-sel').selectedIndex].text,
                quantity: UrbanPaintPro.currentQty,
                paint: document.getElementById('prod-sel').options[document.getElementById('prod-sel').selectedIndex].text,
                estimate: document.getElementById('total-price').innerText,
                city: UrbanPaintPro.currentCity,
                addr: sanitizeInput(document.getElementById('b-addr').value),
                pin: document.getElementById('b-pin').value,
                date: document.getElementById('slotDate').value,
                time: document.getElementById('slotTime').value,
                notes: sanitizeInput(document.getElementById('b-notes').value),
                images: UrbanPaintPro.uploadedImages,
                amt: amt,
                payId: payId,
                status: "Pending",
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                dateString: new Date().toLocaleString('en-IN')
            };
            
            db.ref('orders').push(orderData)
                .then(ref => {
                    // Add notification
                    db.ref('users/' + user.uid + '/notifications').push({
                        message: `Booking confirmed! Order ID: ${ref.key.slice(-6).toUpperCase()}`,
                        time: firebase.database.ServerValue.TIMESTAMP,
                        read: false,
                        type: 'booking'
                    });
                    
                    setLoading('place-order-btn', false);
                    closeFS('fs-book');
                    document.getElementById('success-message').textContent = 'Your booking has been confirmed! Order ID: ' + ref.key.slice(-6).toUpperCase();
                    document.getElementById('status-success').classList.add('active');
                    
                    // Reset form
                    UrbanPaintPro.uploadedImages = [];
                    document.getElementById('b-addr').value = '';
                    document.getElementById('b-pin').value = '';
                    document.getElementById('b-notes').value = '';
                    document.getElementById('slotDate').value = '';
                })
                .catch(err => {
                    setLoading('place-order-btn', false);
                    showToast('Error: ' + err.message, 'error');
                });
        }
        
        function activatePlan(plan, payId) {
            const user = auth.currentUser;
            if (!user) return;
            
            setLoading('verify-payment-btn', true);
            
            const exp = new Date();
            exp.setFullYear(exp.getFullYear() + 1);
            
            db.ref('users/' + user.uid + '/plan').set({
                name: plan + " Member",
                exp: exp.toLocaleDateString('en-IN'),
                payId: payId,
                activatedOn: new Date().toLocaleString('en-IN'),
                status: 'active'
            }).then(() => {
                setLoading('verify-payment-btn', false);
                showToast('Plan activated successfully!', 'success');
                closeFS('fs-plans');
                
                // Add notification
                db.ref('users/' + user.uid + '/notifications').push({
                    message: `Congratulations! Your ${plan} Membership is now active.`,
                    time: firebase.database.ServerValue.TIMESTAMP,
                    read: false,
                    type: 'plan'
                });
            }).catch(err => {
                setLoading('verify-payment-btn', false);
                showToast('Error: ' + err.message, 'error');
            });
        }
      
      // ==================== ORDERS & TRACKING ====================
      
      function loadRealData(userEmail) {
          if (!userEmail) return;
          
          document.getElementById('order-loading').style.display = 'block';
          document.getElementById('order-list').innerHTML = '';
          
          db.ref('orders').orderByChild('user').equalTo(userEmail).on('value', snap => {
              document.getElementById('order-loading').style.display = 'none';
              const list = document.getElementById('order-list');
              
              if (snap.exists()) {
                  const orders = [];
                  snap.forEach(child => {
                      orders.push({ key: child.key, ...child.val() });
                  });
                  orders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                  
                  list.innerHTML = orders.map(o => renderOrderCard(o)).join('');
              } else {
                  list.innerHTML = `
                      <div style="text-align: center; padding: 60px 20px; color: #9CA3AF;">
                          <i class="fas fa-box-open" style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;"></i>
                          <h3 style="color: #64748B; margin-bottom: 10px;">No orders yet</h3>
                          <p style="font-size: 0.9rem;">Book your first painting service today!</p>
                          <button class="btn" onclick="nav('home')" style="margin-top: 20px; width: auto; padding: 12px 30px;">
                              Book Now
                          </button>
                      </div>
                  `;
              }
          }, err => {
              document.getElementById('order-loading').style.display = 'none';
              console.error('Error loading orders:', err);
          });
      }
      
      function renderOrderCard(o) {
          const s = o.status || 'Pending';
          const isLive = ['Accepted', 'Partner Assigned', 'In Progress'].includes(s);
          const isCompleted = s === 'Completed';
          
          const pName = o.partnerName || "Finding Expert...";
          const pPhoto = o.partnerPhoto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
          const pPhone = o.partnerPhone || "#";
          const otp = o.otp || "----";
          
          let s1 = 'done', s2 = isLive || isCompleted ? 'active' : '', s3 = isCompleted ? 'done' : '';
          let statusMsg = "We are finding the best painter for you...";
          
          if (isLive) {
              s2 = 'active';
              statusMsg = `${pName} is assigned and will arrive at scheduled time.`;
          }
          if (isCompleted) {
              s2 = 'done';
              s3 = 'done';
              statusMsg = "Service completed! Please rate your experience.";
          }
          
          const orderId = o.key.slice(-6).toUpperCase();
          const showRating = isCompleted && !o.rated;
          
          return `
              <div class="uber-card" id="order-${o.key}">
                  <div class="map-zone">
                      ${!isLive ? `
                          <div class="radar-scan"></div>
                          <div class="radar-icon"><i class="fas fa-search"></i></div>
                      ` : ''}
                      ${isLive ? `
                          <div class="live-marker">
                              <img src="${pPhoto}" alt="Partner">
                          </div>
                      ` : ''}
                      <div class="partner-float ${isLive ? 'visible' : ''}">
                          <div class="p-details">
                              <img src="${pPhoto}" style="width: 42px; height: 42px; border-radius: 12px; object-fit: cover;">
                              <div>
                                  <div class="p-name">${sanitizeInput(pName)}</div>
                                  <div class="p-otp">OTP: <b style="color: #4F46E5;">${otp}</b></div>
                              </div>
                          </div>
                          ${isLive ? `<a href="tel:${pPhone}" class="call-btn"><i class="fas fa-phone-alt"></i></a>` : ''}
                      </div>
                  </div>
                  
                  <div class="status-sheet">
                      <div class="drag-bar"></div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                          <div>
                              <h3 style="margin: 0; font-size: 18px;">${s}</h3>
                              <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #6B7280;">${o.serviceType || 'Painting'} ‚Ä¢ ${o.scope}</p>
                          </div>
                          <span style="font-size: 12px; color: #6B7280; background: #F3F4F6; padding: 4px 10px; border-radius: 20px; font-weight: 600;">#${orderId}</span>
                      </div>
                      
                      <p style="color: #6B7280; font-size: 13px; margin-bottom: 25px; line-height: 1.5;">${statusMsg}</p>
                      
                      <div class="u-step ${s1}">
                          <div class="u-line"></div>
                          <div class="u-icon"><i class="fas fa-check"></i></div>
                          <div>
                              <div style="font-weight: 600; font-size: 14px; color: #1F2937;">Booking Confirmed</div>
                              <div style="font-size: 12px; color: #9CA3AF;">${o.dateString || 'Just now'}</div>
                          </div>
                      </div>
                      
                      <div class="u-step ${s2}">
                          <div class="u-line"></div>
                          <div class="u-icon"><i class="fas fa-user"></i></div>
                          <div>
                              <div style="font-weight: 600; font-size: 14px; color: #1F2937;">Partner Assigned</div>
                              <div style="font-size: 12px; color: #9CA3AF;">${isLive || isCompleted ? 'Expert assigned' : 'Finding expert...'}</div>
                          </div>
                      </div>
                      
                      <div class="u-step ${s3}">
                          <div class="u-icon"><i class="fas fa-paint-roller"></i></div>
                          <div>
                              <div style="font-weight: 600; font-size: 14px; color: #1F2937;">Work Completed</div>
                              <div style="font-size: 12px; color: #9CA3AF;">${isCompleted ? 'Service finished' : 'Pending'}</div>
                          </div>
                      </div>
                      
                      ${showRating ? `
                          <button class="btn" onclick="openRating('${o.key}')" style="margin-top: 20px; background: #F59E0B;">
                              <i class="fa-solid fa-star"></i> Rate Service
                          </button>
                      ` : ''}
                      
                      ${o.rated ? `
                          <div style="margin-top: 20px; padding: 12px; background: #F0FDF4; border-radius: 8px; text-align: center; color: #166534;">
                              <i class="fa-solid fa-check-circle"></i> You rated this service ${o.rating} stars
                          </div>
                      ` : ''}
                  </div>
              </div>
          `;
      }
      
      // ==================== RATING SYSTEM ====================
      
      function openRating(orderId) {
          UrbanPaintPro.currentRatingOrder = orderId;
          UrbanPaintPro.currentRating = 0;
          updateStarDisplay();
          document.getElementById('rating-comment').value = '';
          document.getElementById('rating-text').innerText = 'Tap to rate';
          openFS('fs-rating');
      }
      
      function setRating(rating) {
          UrbanPaintPro.currentRating = rating;
          updateStarDisplay();
          
          const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
          document.getElementById('rating-text').innerText = ratingTexts[rating];
      }
      
      function updateStarDisplay() {
          document.querySelectorAll('#star-rating .star').forEach((star, index) => {
              if (index < UrbanPaintPro.currentRating) {
                  star.classList.add('active');
                  star.style.color = '#fbbf24';
              } else {
                  star.classList.remove('active');
                  star.style.color = '#ccc';
              }
          });
      }
      
      function submitRating() {
          if (UrbanPaintPro.currentRating === 0) {
              showToast('Please select a rating', 'warning');
              return;
          }
          
          setLoading('submit-rating-btn', true);
          
          const updates = {
              rated: true,
              rating: UrbanPaintPro.currentRating,
              review: sanitizeInput(document.getElementById('rating-comment').value),
              ratedAt: firebase.database.ServerValue.TIMESTAMP
          };
          
          db.ref('orders/' + UrbanPaintPro.currentRatingOrder).update(updates)
              .then(() => {
                  setLoading('submit-rating-btn', false);
                  closeFS('fs-rating');
                  showToast('Thank you for your feedback!', 'success');
                  
                  // Update partner rating if exists
                  db.ref('orders/' + UrbanPaintPro.currentRatingOrder).once('value').then(snap => {
                      const order = snap.val();
                      if (order.partnerId) {
                          updatePartnerRating(order.partnerId, UrbanPaintPro.currentRating);
                      }
                  });
              })
              .catch(err => {
                  setLoading('submit-rating-btn', false);
                  showToast('Error submitting rating', 'error');
              });
      }
      
      function updatePartnerRating(partnerId, rating) {
          const ref = db.ref('partners/' + partnerId + '/ratings');
          ref.push({
              rating: rating,
              timestamp: firebase.database.ServerValue.TIMESTAMP
          });
      }
      
      // ==================== AUTHENTICATION ====================
      
      function login() {
          const email = document.getElementById('l-email').value.trim();
          const pass = document.getElementById('l-pass').value;
          
          if (!validateEmail(document.getElementById('l-email'))) return;
          if (!validatePassword(document.getElementById('l-pass'))) return;
          
          setLoading('login-btn', true);
          
          auth.signInWithEmailAndPassword(email, pass)
              .then(() => {
                  setLoading('login-btn', false);
                  closeFS('fs-login');
                  showToast('Welcome back!', 'success');
              })
              .catch(err => {
                  setLoading('login-btn', false);
                  showToast(getAuthErrorMessage(err.code), 'error');
              });
      }
      
      function loginFromSheet() {
          const email = document.getElementById('fs-l-email').value.trim();
          const pass = document.getElementById('fs-l-pass').value;
          
          if (!validateEmail(document.getElementById('fs-l-email'))) return;
          if (!validatePassword(document.getElementById('fs-l-pass'))) return;
          
          setLoading('fs-login-btn', true);
          
          auth.signInWithEmailAndPassword(email, pass)
              .then(() => {
                  setLoading('fs-login-btn', false);
                  closeFS('fs-login');
                  showToast('Welcome back!', 'success');
              })
              .catch(err => {
                  setLoading('fs-login-btn', false);
                  showToast(getAuthErrorMessage(err.code), 'error');
              });
      }
      
      function signup() {
          const name = document.getElementById('s-name').value.trim();
          const email = document.getElementById('s-email').value.trim();
          const pass = document.getElementById('s-pass').value;
          const phone = document.getElementById('s-phone').value.trim();
          
          if (!validateName(document.getElementById('s-name'))) return;
          if (!validateEmail(document.getElementById('s-email'))) return;
          if (!validatePassword(document.getElementById('s-pass'))) return;
          if (!validatePhone(document.getElementById('s-phone'))) return;
          
          setLoading('signup-btn', true);
          
          auth.createUserWithEmailAndPassword(email, pass)
              .then(cred => {
                  const user = cred.user;
                  const profileData = {
                      name: name,
                      email: email,
                      phone: phone,
                      createdAt: firebase.database.ServerValue.TIMESTAMP
                  };
                  
                  return Promise.all([
                      user.updateProfile({ displayName: name }),
                      db.ref('users/' + user.uid + '/profile').set(profileData)
                  ]);
              })
              .then(() => {
                  setLoading('signup-btn', false);
                  closeFS('fs-signup');
                  showToast('Account created successfully!', 'success');
              })
              .catch(err => {
                  setLoading('signup-btn', false);
                  showToast(getAuthErrorMessage(err.code), 'error');
              });
      }
      
      function googleLogin() {
          const provider = new firebase.auth.GoogleAuthProvider();
          
          auth.signInWithPopup(provider)
              .then(result => {
                  const user = result.user;
                  // Check if new user
                  db.ref('users/' + user.uid + '/profile').once('value').then(snap => {
                      if (!snap.exists()) {
                          db.ref('users/' + user.uid + '/profile').set({
                              name: user.displayName,
                              email: user.email,
                              createdAt: firebase.database.ServerValue.TIMESTAMP
                          });
                      }
                  });
                  closeFS('fs-login');
                  closeFS('fs-signup');
                  showToast('Welcome!', 'success');
              })
              .catch(err => {
                  showToast(getAuthErrorMessage(err.code), 'error');
              });
      }
      
      function resetPass() {
          const email = document.getElementById('fs-l-email').value.trim();
          if (!email) {
              showToast('Please enter your email', 'warning');
              return;
          }
          
          auth.sendPasswordResetEmail(email)
              .then(() => {
                  showToast('Password reset link sent!', 'success');
              })
              .catch(err => {
                  showToast(getAuthErrorMessage(err.code), 'error');
              });
      }
      
      function logout() {
          if (confirm('Are you sure you want to logout?')) {
              // Clean up listeners
              UrbanPaintPro.listeners.forEach(listener => listener.off());
              UrbanPaintPro.listeners = [];
              
              auth.signOut()
                  .then(() => {
                      showToast('Logged out successfully', 'success');
                      setTimeout(() => location.reload(), 1000);
                  })
                  .catch(err => {
                      showToast('Error logging out', 'error');
                  });
          }
      }
      
      function getAuthErrorMessage(code) {
          const messages = {
              'auth/user-not-found': 'No account found with this email',
              'auth/wrong-password': 'Incorrect password',
              'auth/invalid-email': 'Invalid email address',
              'auth/weak-password': 'Password should be at least 6 characters',
              'auth/email-already-in-use': 'An account already exists with this email',
              'auth/invalid-credential': 'Invalid email or password',
              'auth/popup-closed-by-user': 'Login cancelled',
              'auth/network-request-failed': 'Network error. Please check your connection'
          };
          return messages[code] || 'An error occurred. Please try again.';
      }
      
      function switchAuth(type) {
          document.getElementById('fs-login').classList.remove('active');
          document.getElementById('fs-signup').classList.remove('active');
          document.getElementById('fs-' + type).classList.add('active');
      }
      
      // ==================== PROFILE & SETTINGS ====================
      
      function saveProfile() {
          const name = document.getElementById('edit-name').value.trim();
          const phone = document.getElementById('edit-phone').value.trim();
          
          if (!name) {
              showToast('Name is required', 'warning');
              return;
          }
          
          const user = auth.currentUser;
          const updates = [
              user.updateProfile({ displayName: name })
          ];
          
          if (phone) {
              updates.push(db.ref('users/' + user.uid + '/profile/phone').set(phone));
          }
          
          Promise.all(updates)
              .then(() => {
                  document.getElementById('u-name').innerText = name;
                  document.getElementById('avatar').innerText = name[0].toUpperCase();
                  showToast('Profile updated!', 'success');
                  closeFS('fs-personal');
              })
              .catch(err => {
                  showToast('Error updating profile', 'error');
              });
      }
      
      function saveNewAddress() {
          const addr = document.getElementById('new-address-input').value.trim();
          const city = document.getElementById('new-address-city').value.trim();
          const pin = document.getElementById('new-address-pin').value.trim();
          
          if (!addr) {
              showToast('Please enter address', 'warning');
              return;
          }
          
          const fullAddress = `${addr}${city ? ', ' + city : ''}${pin ? ' - ' + pin : ''}`;
          
          setLoading('save-address-btn', true);
          
          db.ref('users/' + auth.currentUser.uid + '/addresses').push(fullAddress)
              .then(() => {
                  setLoading('save-address-btn', false);
                  document.getElementById('new-address-input').value = '';
                  document.getElementById('new-address-city').value = '';
                  document.getElementById('new-address-pin').value = '';
                  showToast('Address saved!', 'success');
                  closeFS('fs-add-address');
              })
              .catch(err => {
                  setLoading('save-address-btn', false);
                  showToast('Error saving address', 'error');
              });
      }
      
      function deleteAddress(key) {
          if (confirm('Delete this address?')) {
              db.ref('users/' + auth.currentUser.uid + '/addresses/' + key).remove()
                  .then(() => showToast('Address deleted', 'success'))
                  .catch(() => showToast('Error deleting address', 'error'));
          }
      }
      
      function toggleDarkMode() {
          const enabled = document.getElementById('dark-toggle').checked;
          if (enabled) {
              document.body.style.filter = 'invert(1) hue-rotate(180deg)';
              document.body.style.background = '#0F172A';
          } else {
              document.body.style.filter = '';
              document.body.style.background = '';
          }
          localStorage.setItem('darkMode', enabled);
      }
      
      function requestNotificationPermission() {
          if (!messaging) return;
          
          Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                  messaging.getToken().then(token => {
                      if (auth.currentUser) {
                          db.ref('users/' + auth.currentUser.uid + '/fcmToken').set(token);
                      }
                  });
              }
          });
      }
      
      function makeCall() {
          window.location.href = 'tel:+919711904092';
      }
      
      // ==================== ENHANCED INVOICE GENERATION ====================
      
      function genInvoice() {
          try {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              
              const user = auth.currentUser;
              const now = new Date();
              
              // Get form values
              const brand = document.getElementById('brand-sel').value;
              const category = document.getElementById('cat-sel').value;
              const product = document.getElementById('prod-sel').options[document.getElementById('prod-sel').selectedIndex].text;
              const scope = document.getElementById('scope-sel').options[document.getElementById('scope-sel').selectedIndex].text;
              const scopeValue = document.getElementById('scope-sel').value;
              const city = UrbanPaintPro.currentCity;
              const qty = UrbanPaintPro.currentQty;
              const totalPrice = document.getElementById('total-price').innerText;
              
              // Header with gradient-like effect
              doc.setFillColor(79, 70, 229);
              doc.rect(0, 0, 210, 50, 'F');
              
              // Company Logo/Name
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(28);
              doc.setFont('helvetica', 'bold');
              doc.text("UrbanPaintPro", 15, 28);
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.text("Professional Painting Services", 15, 38);
              doc.text("Delhi NCR's #1 Painting Service", 15, 45);
              
              // Invoice Title
              doc.setFontSize(20);
              doc.setFont('helvetica', 'bold');
              doc.text("ESTIMATE / INVOICE", 150, 28);
              
              // Invoice Details Box
              doc.setFillColor(248, 250, 252);
              doc.rect(130, 32, 65, 30, 'F');
              doc.setFontSize(9);
              doc.setTextColor(100);
              doc.text(`Invoice #: INV-${Date.now().toString().slice(-8)}`, 135, 42);
              doc.text(`Date: ${now.toLocaleDateString('en-IN')}`, 135, 48);
              doc.text(`Time: ${now.toLocaleTimeString('en-IN')}`, 135, 54);
              doc.text(`Valid For: 7 Days`, 135, 60);
              
              // Customer Details Section
              let yPos = 75;
              doc.setFillColor(238, 242, 255);
              doc.rect(10, yPos - 5, 190, 35, 'F');
              
              doc.setFontSize(12);
              doc.setTextColor(79, 70, 229);
              doc.setFont('helvetica', 'bold');
              doc.text("CUSTOMER DETAILS", 15, yPos + 5);
              
              doc.setFontSize(10);
              doc.setTextColor(0);
              doc.setFont('helvetica', 'normal');
              
              if (user) {
                  doc.text(`Name: ${user.displayName || 'N/A'}`, 15, yPos + 15);
                  doc.text(`Email: ${user.email || 'N/A'}`, 15, yPos + 22);
                  doc.text(`Phone: ${user.phoneNumber || 'N/A'}`, 15, yPos + 29);
              } else {
                  doc.text("Name: Guest User", 15, yPos + 15);
                  doc.text("Email: Not logged in", 15, yPos + 22);
                  doc.text("Phone: N/A", 15, yPos + 29);
              }
              
              // Service Details Section
              yPos = 120;
              doc.setFillColor(255, 251, 235);
              doc.rect(10, yPos - 5, 190, 45, 'F');
              
              doc.setFontSize(12);
              doc.setTextColor(245, 158, 11);
              doc.setFont('helvetica', 'bold');
              doc.text("SERVICE DETAILS", 15, yPos + 5);
              
              doc.setFontSize(10);
              doc.setTextColor(0);
              doc.setFont('helvetica', 'normal');
              doc.text(`Service Type: ${UrbanPaintPro.currentService.charAt(0).toUpperCase() + UrbanPaintPro.currentService.slice(1)}`, 15, yPos + 15);
              doc.text(`Paint Brand: ${brand}`, 15, yPos + 22);
              doc.text(`Category: ${category}`, 15, yPos + 29);
              doc.text(`Product: ${product}`, 15, yPos + 36);
              doc.text(`Scope: ${scope}`, 110, yPos + 15);
              doc.text(`City: ${city.charAt(0).toUpperCase() + city.slice(1)}`, 110, yPos + 22);
              doc.text(`Quantity: ${qty} Unit(s)`, 110, yPos + 29);
              
              // Cost Breakdown Table
              yPos = 175;
              doc.setFontSize(12);
              doc.setTextColor(79, 70, 229);
              doc.setFont('helvetica', 'bold');
              doc.text("COST BREAKDOWN", 15, yPos);
              
              const paintPrice = parseFloat(document.getElementById('prod-sel').value) || 0;
              const laborPrice = 8;
              const areaPerUnit = scopeValue == 1 ? 1500 : scopeValue == 0.8 ? 1200 : scopeValue == 0.5 ? 900 : 450;
              const surge = citySurge[city] || 1;
              const subtotal = (paintPrice + laborPrice) * qty * areaPerUnit;
              const surgeAmount = subtotal * (surge - 1);
              const total = Math.round(subtotal * surge);
              
              const tableData = [
                  ['Item', 'Details', 'Amount'],
                  ['Paint Cost', `${brand} - ${product.split('-')[0]} @ ‚Çπ${paintPrice}/sqft`, '‚Çπ' + (paintPrice * qty * areaPerUnit).toLocaleString('en-IN')],
                  ['Labor Charges', `Painting labor @ ‚Çπ${laborPrice}/sqft`, '‚Çπ' + (laborPrice * qty * areaPerUnit).toLocaleString('en-IN')],
                  ['Area Coverage', `${areaPerUnit} sqft per unit √ó ${qty} unit(s)`, `${qty * areaPerUnit} sqft`],
                  ['City Factor', `${city.charAt(0).toUpperCase() + city.slice(1)} (${(surge * 100 - 100).toFixed(0)}% adjustment)`, surge > 1 ? '+‚Çπ' + Math.round(surgeAmount).toLocaleString('en-IN') : '‚Çπ0'],
                  ['', '', ''],
                  ['ESTIMATED TOTAL', '', totalPrice]
              ];
              
              doc.autoTable({
                  startY: yPos + 5,
                  head: [['Item', 'Details', 'Amount']],
                  body: tableData.slice(1),
                  headStyles: { 
                      fillColor: [79, 70, 229], 
                      textColor: 255,
                      fontStyle: 'bold'
                  },
                  alternateRowStyles: { fillColor: [248, 250, 252] },
                  columnStyles: {
                      0: { fontStyle: 'normal', cellWidth: 40 },
                      1: { fontStyle: 'normal', cellWidth: 100 },
                      2: { halign: 'right', fontStyle: 'bold', cellWidth: 40 }
                  },
                  styles: {
                      fontSize: 9,
                      cellPadding: 5
                  },
                  didParseCell: function(data) {
                      // Make the total row bold and colored
                      if (data.row.index === tableData.length - 2) {
                          data.cell.styles.fillColor = [79, 70, 229];
                          data.cell.styles.textColor = [255, 255, 255];
                          data.cell.styles.fontStyle = 'bold';
                      }
                  }
              });
              
              // Terms & Notes
              yPos = doc.lastAutoTable.finalY + 15;
              doc.setFontSize(10);
              doc.setTextColor(79, 70, 229);
              doc.setFont('helvetica', 'bold');
              doc.text("TERMS & CONDITIONS", 15, yPos);
              
              doc.setFontSize(8);
              doc.setTextColor(100);
              doc.setFont('helvetica', 'normal');
              const terms = [
                  "1. This is a computer-generated estimate based on standard measurements.",
                  "2. Final quote will be provided after physical site inspection.",
                  "3. Visiting charge of ‚Çπ49 is adjustable in the final bill.",
                  "4. Prices are valid for 7 days from the date of generation.",
                  "5. 1-year warranty on all painting services.",
                  "6. Material costs may vary based on actual consumption."
              ];
              
              terms.forEach((term, i) => {
                  doc.text(term, 15, yPos + 8 + (i * 4));
              });
              
              // Contact Information
              yPos = 270;
              doc.setFillColor(248, 250, 252);
              doc.rect(10, yPos - 5, 190, 22, 'F');
              
              doc.setFontSize(9);
              doc.setTextColor(79, 70, 229);
              doc.setFont('helvetica', 'bold');
              doc.text("CONTACT US", 15, yPos + 3);
              
              doc.setFontSize(8);
              doc.setTextColor(100);
              doc.setFont('helvetica', 'normal');
              doc.text("WhatsApp: +91 9711904092", 15, yPos + 10);
              doc.text("Email: urbanpaintpro.index@gmail.com", 15, yPos + 15);
              doc.text("Website: www.urbanpaintpro.in", 100, yPos + 10);
              doc.text("Service Area: Delhi NCR", 100, yPos + 15);
              
              // Footer
              doc.setFontSize(8);
              doc.setTextColor(150);
              doc.text("Thank you for choosing UrbanPaintPro! | This is a system-generated document.", 105, 290, { align: 'center' });
              
              // Save PDF
              doc.save(`UrbanPaintPro_Invoice_${now.getTime()}.pdf`);
              showToast('Invoice downloaded successfully!', 'success');
              
          } catch (e) {
              console.error(e);
              showToast('Error generating invoice: ' + e.message, 'error');
          }
      }
      
      // ==================== CHAT FUNCTIONS ====================
      
      function handleChat(e) {
          if (e.key === 'Enter') sendChat();
      }
      
      function sendChat() {
          const inp = document.getElementById('chat-in');
          const box = document.getElementById('chat-box');
          const msg = inp.value.trim();
          
          if (!msg) return;
          
          // Add user message
          box.innerHTML += `<div class="chat-msg chat-user">${sanitizeInput(msg)}</div>`;
          inp.value = "";
          box.scrollTop = box.scrollHeight;
          
          // Simple AI responses
          setTimeout(() => {
              const responses = {
                  'price': 'Our prices start from ‚Çπ12 per sq ft. The estimate calculator on home page gives you exact pricing based on your requirements.',
                  'cost': 'Our prices start from ‚Çπ12 per sq ft. The estimate calculator on home page gives you exact pricing based on your requirements.',
                  'warranty': 'We offer 1-year warranty on all painting services. Membership plans get extended warranty up to 3 years.',
                  'book': 'To book a service, select your city, choose service type, and click "Book Inspection Visit". It takes just 2 minutes!',
                  'booking': 'To book a service, select your city, choose service type, and click "Book Inspection Visit". It takes just 2 minutes!',
                  'time': 'A standard 2BHK takes 3-4 days. We provide exact timeline after inspection.',
                  'duration': 'A standard 2BHK takes 3-4 days. We provide exact timeline after inspection.',
                  'payment': 'We accept UPI, Cash, and Card payments. You can also buy our membership plans for additional benefits.',
                  'pay': 'We accept UPI, Cash, and Card payments. You can also buy our membership plans for additional benefits.',
                  'membership': 'Our Gold plan (‚Çπ399) gives 15% off + free visits. Platinum (‚Çπ599) gives 20% off + priority support. Check Account > My Plans!',
                  'plan': 'Our Gold plan (‚Çπ399) gives 15% off + free visits. Platinum (‚Çπ599) gives 20% off + priority support. Check Account > My Plans!',
                  'cancel': 'You can cancel your booking up to 2 hours before the scheduled time. Visit My Bookings to cancel.',
                  'help': 'For immediate help, WhatsApp us at +91 9711904092 or email urbanpaintpro.index@gmail.com'
              };
              
              let reply = "I'm here to help with painting services, pricing, and bookings. What would you like to know?";
              const lowerMsg = msg.toLowerCase();
              
              for (const [key, value] of Object.entries(responses)) {
                  if (lowerMsg.includes(key)) {
                      reply = value;
                      break;
                  }
              }
              
              box.innerHTML += `<div class="chat-msg chat-ai">${reply}</div>`;
              box.scrollTop = box.scrollHeight;
          }, 800);
      }
      
      // AI Chat in Full Sheet
      function handleAIChat(e) {
          if (e.key === 'Enter') sendAIChat();
      }
      
      function sendAIChat() {
          const inp = document.getElementById('ai-chat-in');
          const box = document.getElementById('ai-chat-box');
          const msg = inp.value.trim();
          
          if (!msg) return;
          
          // Add user message
          box.innerHTML += `<div class="chat-msg chat-user">${sanitizeInput(msg)}</div>`;
          inp.value = "";
          box.scrollTop = box.scrollHeight;
          
          // Enhanced AI responses
          setTimeout(() => {
              const responses = {
                  'price': 'Our prices start from ‚Çπ12 per sq ft. Use the calculator on the home page for exact pricing based on your requirements.',
                  'cost': 'Our prices start from ‚Çπ12 per sq ft. Use the calculator on the home page for exact pricing based on your requirements.',
                  'warranty': 'We offer 1-year warranty on all painting services. Membership plans get extended warranty up to 3 years.',
                  'book': 'To book a service, select your city, choose service type, and click "Book Inspection Visit". It takes just 2 minutes!',
                  'booking': 'To book a service, select your city, choose service type, and click "Book Inspection Visit". It takes just 2 minutes!',
                  'time': 'A standard 2BHK takes 3-4 days. We provide exact timeline after inspection.',
                  'duration': 'A standard 2BHK takes 3-4 days. We provide exact timeline after inspection.',
                  'payment': 'We accept UPI, Cash, and Card payments. You can also buy our membership plans for additional benefits.',
                  'pay': 'We accept UPI, Cash, and Card payments. You can also buy our membership plans for additional benefits.',
                  'membership': 'Our Gold plan (‚Çπ399) gives 15% off + free visits. Platinum (‚Çπ599) gives 20% off + priority support. Check Account > My Plans!',
                  'plan': 'Our Gold plan (‚Çπ399) gives 15% off + free visits. Platinum (‚Çπ599) gives 20% off + priority support. Check Account > My Plans!',
                  'cancel': 'You can cancel your booking up to 2 hours before the scheduled time. Visit My Bookings to cancel.',
                  'help': 'For immediate help, WhatsApp us at +91 9711904092 or email urbanpaintpro.index@gmail.com',
                  'contact': 'You can reach us at: WhatsApp: +91 9711904092, Email: urbanpaintpro.index@gmail.com',
                  'hello': 'Hello! Welcome to UrbanPaintPro. How can I help you today?',
                  'hi': 'Hi there! How can I assist you with your painting needs?',
                  'asian': 'Asian Paints is one of our premium brands. We offer Tractor Emulsion (‚Çπ12/sqft), Apcolite Premium (‚Çπ20/sqft), Royale Luxury (‚Çπ26/sqft), and Royale Aspira (‚Çπ35/sqft).',
                  'berger': 'Berger Paints offers great quality. We have Bison Emulsion (‚Çπ13/sqft), Silk Glamor (‚Çπ28/sqft), and Easy Clean (‚Çπ22/sqft).',
                  'waterproofing': 'We offer waterproofing services starting at ‚Çπ75/sqft. Products include Damp Block, Crack Fill, and SmartCare solutions.',
                  'texture': 'Texture painting adds beautiful patterns to your walls. Prices vary based on design complexity. Book an inspection for exact quote.',
                  'discount': 'Get 15% off with our Gold Membership (‚Çπ399/year) or 20% off with Platinum (‚Çπ599/year). Both include free inspection visits!'
              };
              
              let reply = "I'm UrbanPaintPro AI, here to help with painting services, pricing, and bookings. Ask me anything about our services!";
              const lowerMsg = msg.toLowerCase();
              
              for (const [key, value] of Object.entries(responses)) {
                  if (lowerMsg.includes(key)) {
                      reply = value;
                      break;
                  }
              }
              
              box.innerHTML += `<div class="chat-msg chat-ai">${reply}</div>`;
              box.scrollTop = box.scrollHeight;
          }, 600);
      }
      
      // ==================== NAVIGATION & UI ====================
      
      function nav(page, element) {
          document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
          document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
          
          const targetPage = document.getElementById(page);
          if (targetPage) targetPage.classList.add('active');
          
          if (element) {
              element.classList.add('active');
          } else {
              const navItem = document.querySelector(`.nav-item[onclick*="'${page}'"]`);
              if (navItem) navItem.classList.add('active');
          }
          
          // Close any open sheets
          closeAllSheets();
          
          // Scroll to top
          window.scrollTo(0, 0);
      }
      
      function openFS(id) {
          const sheet = document.getElementById(id);
          if (sheet) {
              sheet.classList.add('active');
              document.body.style.overflow = 'hidden';
          }
      }
      
      function closeFS(id) {
          if (id) {
              const sheet = document.getElementById(id);
              if (sheet) sheet.classList.remove('active');
          } else {
              document.querySelectorAll('.full-sheet').forEach(s => s.classList.remove('active'));
          }
          
          // Check if any sheet is still active
          const anyActive = document.querySelectorAll('.full-sheet.active').length > 0;
          if (!anyActive) {
              document.body.style.overflow = '';
          }
      }
      
      function closeAllSheets() {
          document.querySelectorAll('.full-sheet').forEach(s => s.classList.remove('active'));
          document.getElementById('overlay').classList.remove('active');
          document.body.style.overflow = '';
      }
      
      function closeStatus() {
          document.querySelectorAll('.status-screen').forEach(s => s.classList.remove('active'));
          if (document.getElementById('status-success').classList.contains('active')) {
              window.location.reload();
          }
      }
      
      function setLang(l, showMsg = true) {
          UrbanPaintPro.currentLang = l;
          localStorage.setItem('language', l);
          
          document.querySelectorAll('[data-lang]').forEach(el => {
              const key = el.getAttribute('data-lang');
              if (dict[l] && dict[l][key]) {
                  el.innerText = dict[l][key];
              }
          });
          
          // Update checkmarks
          document.querySelectorAll('[id^="lang-check-"]').forEach(el => el.style.display = 'none');
          const check = document.getElementById('lang-check-' + l);
          if (check) check.style.display = 'inline-block';
          
          if (showMsg) {
              showToast('Language updated!', 'success');
              closeFS('fs-language');
          }
      }
      
      // Close sheets on escape key
      document.addEventListener('keydown', e => {
          if (e.key === 'Escape') {
              closeAllSheets();
          }
      });
      
      // Prevent zoom on double tap (mobile)
      let lastTouchEnd = 0;
      document.addEventListener('touchend', e => {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
              e.preventDefault();
          }
          lastTouchEnd = now;
      }, false);
      
      // Initialize language checkmarks
      document.addEventListener('DOMContentLoaded', () => {
          const check = document.getElementById('lang-check-' + UrbanPaintPro.currentLang);
          if (check) check.style.display = 'inline-block';
      });
      
      // Buy Plan function
      function buyPlan(plan) {
          const planPrices = { 'gold': 399, 'platinum': 599, 'pro': 499 };
          const price = planPrices[plan.toLowerCase()] || 399;
          openUPIPayment(plan.charAt(0).toUpperCase() + plan.slice(1) + ' Plan', price, 'plan');
      }
      
      // Add New Address function
      function addNewAddress() {
          openFS('fs-add-address');
      }
      
      // ==================== WARRANTY FUNCTIONS ====================
      
      function submitWarrantyClaim() {
          const orderId = document.getElementById('warranty-order-id').value.trim();
          const issue = document.getElementById('warranty-issue').value.trim();
          
          if (!orderId) {
              showToast('Please enter your Order ID', 'warning');
              return;
          }
          
          if (!issue) {
              showToast('Please describe the issue', 'warning');
              return;
          }
          
          const user = auth.currentUser;
          if (!user) {
              showToast('Please login to submit a claim', 'error');
              openFS('fs-login');
              return;
          }
          
          // Save warranty claim to database
          db.ref('warranty-claims').push({
              userId: user.uid,
              userEmail: user.email,
              orderId: orderId,
              issue: sanitizeInput(issue),
              status: 'Pending',
              createdAt: firebase.database.ServerValue.TIMESTAMP,
              dateString: new Date().toLocaleString('en-IN')
          }).then(() => {
              showToast('Warranty claim submitted successfully!', 'success');
              document.getElementById('warranty-order-id').value = '';
              document.getElementById('warranty-issue').value = '';
              
              // Add notification
              db.ref('users/' + user.uid + '/notifications').push({
                  message: `Warranty claim submitted for Order #${orderId}. Our team will contact you soon.`,
                  time: firebase.database.ServerValue.TIMESTAMP,
                  read: false,
                  type: 'warranty'
              });
          }).catch(err => {
              showToast('Error submitting claim: ' + err.message, 'error');
          });
      }
      
      // ==================== AMC FUNCTIONS ====================
      
      function buyAMC(plan) {
          const amcPrices = { 'basic': 1999, 'standard': 3999, 'premium': 7999 };
          const price = amcPrices[plan.toLowerCase()] || 1999;
          
          const planNames = { 
              'basic': 'Basic AMC', 
              'standard': 'Standard AMC', 
              'premium': 'Premium AMC' 
          };
          
          openUPIPayment(planNames[plan.toLowerCase()], price, 'amc');
      }
      
      // Handle AMC payment verification
      function verifyAMCPayment(utr) {
          const user = auth.currentUser;
          if (!user) return;
          
          const amcData = {
              plan: UrbanPaintPro.pendingPayment.desc,
              amount: UrbanPaintPro.pendingPayment.amt,
              payId: "UPI-" + utr,
              activatedOn: new Date().toLocaleString('en-IN'),
              validTill: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString('en-IN'),
              status: 'active',
              visitsUsed: 0
          };
          
          db.ref('users/' + user.uid + '/amc').set(amcData)
              .then(() => {
                  showToast('AMC activated successfully!', 'success');
                  closeFS('fs-amc');
                  
                  // Add notification
                  db.ref('users/' + user.uid + '/notifications').push({
                      message: `Your ${amcData.plan} is now active! Valid till ${amcData.validTill}.`,
                      time: firebase.database.ServerValue.TIMESTAMP,
                      read: false,
                      type: 'amc'
                  });
              })
              .catch(err => {
                  showToast('Error activating AMC: ' + err.message, 'error');
              });
      }
      
    </script>
</body>
</html>
